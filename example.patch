From 7b6f2740fbc16cec400e94525f960db5496233ef Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Tue, 17 Feb 2026 10:55:58 +0100
Subject: [PATCH 01/32] remove unnecessary parameters and fix typing issues

---
 .../src/state/http_route.py                   | 71 +++++++++++--------
 1 file changed, 42 insertions(+), 29 deletions(-)

diff --git a/gateway-api-integrator/src/state/http_route.py b/gateway-api-integrator/src/state/http_route.py
index 86d52e06..15ec8de4 100644
--- a/gateway-api-integrator/src/state/http_route.py
+++ b/gateway-api-integrator/src/state/http_route.py
@@ -27,6 +27,13 @@ class IngressGatewayRouteConflictError(CharmStateValidationBaseError):
     """Exception raised when both ingress and gateway-route integrations are established."""
 
 
+class GatewayRouteHostnameMissingError(CharmStateValidationBaseError):
+    """Exception raised when hostname not configured in gateway-route mode.
+
+    Hostname is configured either via the gateway-route relation or by setting external-hostname.
+    """
+
+
 @dataclasses.dataclass(frozen=True)
 class HTTPRouteResourceInformation:
     """A component of charm state containing resource definition for kubernetes secret.
@@ -52,19 +59,18 @@ class HTTPRouteResourceInformation:
     hostname: str
 
     @classmethod
-    def from_charm(
+    def from_provider(
         cls,
-        charm: ops.CharmBase,
+        external_hostname: str | None,
         ingress_provider: IngressPerAppProvider,
         gateway_route_provider: GatewayRouteProvider,
     ) -> "HTTPRouteResourceInformation":
         """Get TLS information from a charm instance.
 
         Args:
-            charm (ops.CharmBase): The gateway-api-integrator charm.
-            ingress_provider (IngressPerAppProvider): The ingress provider library.
-            gateway_route_provider (GatewayRouteProvider): The gateway route provider library.
-
+            external_hostname: The external-hostname charm configuration.
+            ingress_provider: The ingress provider library.
+            gateway_route_provider: The gateway route provider library.
 
         Raises:
             IngressIntegrationMissingError: When integration is not ready.
@@ -74,34 +80,35 @@ def from_charm(
         Returns:
             HTTPRouteResourceInformation: Information about configured TLS certs.
         """
-        ingress_integration = charm.model.get_relation(INGRESS_RELATION)
-        gateway_route_integration = charm.model.get_relation(GATEWAY_ROUTE_RELATION)
-        if ingress_integration is None and gateway_route_integration is None:
-            raise IngressIntegrationMissingError(
-                "Ingress and Gateway Route integration not ready. You must relate to either."
-            )
-        if ingress_integration and gateway_route_integration:
+        ingress_relations = ingress_provider.relations
+        gateway_route_relation = gateway_route_provider.relation
+        if ingress_relations and gateway_route_relation is not None:
             raise IngressGatewayRouteConflictError(
                 "Both Ingress and Gateway Route integrations are established. Only one is allowed."
             )
         try:
-            if ingress_integration:
-                return cls._from_ingress(charm, ingress_provider, ingress_integration)
-            else:
+            if ingress_relations:
+                if len(ingress_relations) > 1:
+                    raise IngressIntegrationDataValidationError(
+                        "The charm does not support multiple ingress relations."
+                    )
+                return cls._from_ingress(ingress_provider)
+            if gateway_route_relation is not None:
                 return cls._from_gateway_route(
-                    charm, gateway_route_provider, gateway_route_integration
+                    external_hostname, gateway_route_provider, gateway_route_relation
                 )
         except DataValidationError as exc:
             raise IngressIntegrationDataValidationError(
                 "Validation of ingress relation data failed."
             ) from exc
+        raise IngressIntegrationMissingError(
+            "Ingress and Gateway Route integration not ready. You must relate to either."
+        )
 
     @classmethod
     def _from_ingress(
         cls,
-        charm: ops.CharmBase,
         ingress_provider: IngressPerAppProvider,
-        ingress_integration: ops.Relation | None,
     ) -> "HTTPRouteResourceInformation":
         """Populate fields from ingress integration.
 
@@ -110,10 +117,11 @@ def _from_ingress(
             ingress_provider (IngressPerAppProvider): The ingress provider class.
             ingress_integration (ops.Relation): The ingress integration.
         """
-        integration_data = ingress_provider.get_data(ingress_integration)
+        # Validation that len(ingress_provider.relations) == 1 is done in the caller method
+        integration_data = ingress_provider.get_data(ingress_provider.relations[0])
         application_name = integration_data.app.name
         service_port = integration_data.app.port
-        service_name = f"{charm.app.name}-{application_name}-service"
+        service_name = f"{ingress_provider.charm.app.name}-{application_name}-service"
         return cls(
             application_name=application_name,
             requirer_model_name=integration_data.app.model,
@@ -142,30 +150,35 @@ def _from_ingress(
     @classmethod
     def _from_gateway_route(
         cls,
-        charm: ops.CharmBase,
+        external_hostname: str | None,
         gateway_route_provider: GatewayRouteProvider,
-        gateway_route_integration: ops.Relation | None,
+        gateway_route_integration: ops.Relation,
     ) -> "HTTPRouteResourceInformation":
         """Populate fields from ingress integration.
 
         Args:
-            charm (ops.CharmBase): The gateway-api-integrator charm.
-            gateway_route_provider (GatewayRouteProvider): The gateway-route provider class
-            gateway_route_integration (ops.Relation): The gateway-route integration.
+            external_hostname: The external-hostname charm configuration.
+            gateway_route_provider: The gateway route provider library.
+            gateway_route_integration: The gateway-route integration.
         """
         integration_data = gateway_route_provider.get_data(gateway_route_integration)
         if integration_data is None:
             raise IngressIntegrationMissingError("Gateway Route integration data not ready.")
         application_name = integration_data.application_data.name
         service_port = integration_data.application_data.port
-
+        hostname = integration_data.application_data.hostname or external_hostname
+        if hostname is None:
+            raise IngressIntegrationDataValidationError(
+                "No hostname configured. Configure hostname either via"
+                " the gateway-route relation or by setting the external-hostname charm config."
+            )
         return cls(
             application_name=application_name,
             requirer_model_name=integration_data.application_data.model,
-            service_name=f"{charm.app.name}-{application_name}-service",
+            service_name=f"{gateway_route_provider.charm.app.name}-{application_name}-service",
             service_port=service_port,
             service_port_name=f"tcp-{service_port}",
             filters=[],
             paths=integration_data.application_data.paths,
-            hostname=integration_data.application_data.hostname,
+            hostname=hostname,
         )

From b583d2ee73a492e983dd65f9b5de23eda41fbf89 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Tue, 17 Feb 2026 10:57:13 +0100
Subject: [PATCH 02/32] bump lib version

---
 .../lib/charms/gateway_api_integrator/v0/gateway_route.py       | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index cd7f7430..36cb94c9 100644
--- a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -91,7 +91,7 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 # Increment this PATCH version before using `charmcraft publish-lib` or reset
 # to 0 if you are raising the major API version
-LIBPATCH = 1
+LIBPATCH = 2
 
 logger = logging.getLogger(__name__)
 GATEWAY_ROUTE_RELATION_NAME = "gateway-route"

From 50b98338b67ef0d4038e7b8150cdf733d8599b42 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 18 Feb 2026 15:03:30 +0100
Subject: [PATCH 03/32] undo libpatch changes for gateway-route-configurator

---
 .../lib/charms/gateway_api_integrator/v0/gateway_route.py       | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index 36cb94c9..cd7f7430 100644
--- a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -91,7 +91,7 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 # Increment this PATCH version before using `charmcraft publish-lib` or reset
 # to 0 if you are raising the major API version
-LIBPATCH = 2
+LIBPATCH = 1
 
 logger = logging.getLogger(__name__)
 GATEWAY_ROUTE_RELATION_NAME = "gateway-route"

From 64dad50b3fb9c09c54ef0357a5698cdb882569d0 Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Fri, 13 Feb 2026 10:13:33 +0000
Subject: [PATCH 04/32] Initial plan


From 589d8e3644703fb3c46809826b7f7dd2d39b2e80 Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Fri, 13 Feb 2026 10:18:38 +0000
Subject: [PATCH 05/32] Add enforce-https configuration option and update core
 logic

Co-authored-by: Thanhphan1147 <42444001+Thanhphan1147@users.noreply.github.com>
---
 gateway-api-integrator/charmcraft.yaml        |  7 ++
 gateway-api-integrator/src/charm.py           | 71 ++++++++++++++-----
 .../src/resource_manager/gateway.py           | 48 ++++++++-----
 gateway-api-integrator/src/state/config.py    | 29 ++++++--
 gateway-api-integrator/src/state/tls.py       |  6 +-
 5 files changed, 119 insertions(+), 42 deletions(-)

diff --git a/gateway-api-integrator/charmcraft.yaml b/gateway-api-integrator/charmcraft.yaml
index 5961d78a..3cfddf36 100644
--- a/gateway-api-integrator/charmcraft.yaml
+++ b/gateway-api-integrator/charmcraft.yaml
@@ -59,6 +59,13 @@ config:
       default: ""
       description: The gateway class.
       type: string
+    enforce-https:
+      default: true
+      description: |
+        Whether to enforce HTTPS by redirecting HTTP traffic to HTTPS.
+        When set to false, plain HTTP traffic on port 80 is allowed and the HTTPS listener is not created.
+        Setting this to false also makes the external-hostname configuration optional.
+      type: boolean
 
 
 actions:
diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index c92a2cfe..430e207b 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -237,8 +237,8 @@ def _reconcile(self) -> None:
             2. Create the gateway and secret resources.
             3. Create ingress-related resources:
                 - service
-                - http_route (HTTPS)
-                - http_route (HTTPtoHTTPS redirect)
+                - http_route (HTTPS) or http_route (HTTP) depending on enforce_https
+                - http_route (HTTPtoHTTPS redirect) if enforce_https is true
             4. Publish the ingress URL to the requirer charm.
             5. Update the DNS record relation with the DNS record data
             6. Set the gateway LB address in the charm's status message.
@@ -246,7 +246,12 @@ def _reconcile(self) -> None:
         client = get_client(field_manager=self.app.name, namespace=self.model.name)
         config = CharmConfig.from_charm(self, client)
         gateway_resource_information = GatewayResourceInformation.from_charm(self)
-        tls_information = TLSInformation.from_charm(self, self.certificates)
+        
+        # Only validate TLS information if HTTPS is enforced
+        tls_information = TLSInformation.from_charm(
+            self, self.certificates, validate=config.enforce_https
+        )
+        
         self.unit.status = MaintenanceStatus("Creating resources.")
         resource_manager = GatewayResourceManager(
             labels=self._labels,
@@ -343,6 +348,16 @@ def _define_secret_resources(
             config: Charm config.
             tls_information: TLS-related information needed to create secret resources.
         """
+        # Only create TLS secrets when HTTPS is enforced
+        if not config.enforce_https:
+            # Clean up any existing secrets if HTTPS is not enforced
+            resource_manager = TLSSecretResourceManager(
+                labels=self._labels,
+                client=client,
+            )
+            resource_manager.cleanup_resources(exclude=[])
+            return
+            
         resource_definition = SecretResourceDefinition.from_tls_information(
             tls_information, config.external_hostname
         )
@@ -396,27 +411,43 @@ def _define_ingress_resources_and_publish_url(
             ServiceResourceDefinition(http_route_resource_information)
         )
         http_route_resource_manager = HTTPRouteResourceManager(self._labels, client)
-        redirect_resource_manager = HTTPRouteRedirectResourceManager(self._labels, client)
-        redirect_route = redirect_resource_manager.define_resource(
-            HTTPRouteResourceDefinition(
-                http_route_resource_information,
-                gateway_resource_information,
-                HTTPRouteType.HTTP,
+        
+        if config.enforce_https:
+            # When HTTPS is enforced, create both redirect and HTTPS routes
+            redirect_resource_manager = HTTPRouteRedirectResourceManager(self._labels, client)
+            redirect_route = redirect_resource_manager.define_resource(
+                HTTPRouteResourceDefinition(
+                    http_route_resource_information,
+                    gateway_resource_information,
+                    HTTPRouteType.HTTP,
+                )
             )
-        )
-        https_route = http_route_resource_manager.define_resource(
-            HTTPRouteResourceDefinition(
-                http_route_resource_information,
-                gateway_resource_information,
-                HTTPRouteType.HTTPS,
+            https_route = http_route_resource_manager.define_resource(
+                HTTPRouteResourceDefinition(
+                    http_route_resource_information,
+                    gateway_resource_information,
+                    HTTPRouteType.HTTPS,
+                )
             )
-        )
+            http_route_resource_manager.cleanup_resources(exclude=[https_route, redirect_route])
+        else:
+            # When HTTPS is not enforced, create only HTTP route
+            http_route = http_route_resource_manager.define_resource(
+                HTTPRouteResourceDefinition(
+                    http_route_resource_information,
+                    gateway_resource_information,
+                    HTTPRouteType.HTTP,
+                )
+            )
+            http_route_resource_manager.cleanup_resources(exclude=[http_route])
+        
         service_resource_manager.cleanup_resources(exclude=[service])
-        http_route_resource_manager.cleanup_resources(exclude=[https_route, redirect_route])
         ingress_relation = self.model.get_relation(INGRESS_RELATION)
         if ingress_relation:
+            protocol = "https" if config.enforce_https else "http"
+            hostname = config.external_hostname if config.external_hostname else "localhost"
             ingress_url = (
-                f"https://{config.external_hostname}"
+                f"{protocol}://{hostname}"
                 f"/{http_route_resource_information.requirer_model_name}"
                 f"-{http_route_resource_information.application_name}"
             )
@@ -427,9 +458,11 @@ def _define_ingress_resources_and_publish_url(
             )
 
         if gateway_route_relation := self.model.get_relation(GATEWAY_ROUTE_RELATION):
+            protocol = "https" if config.enforce_https else "http"
+            hostname = self.get_hostname() if self.get_hostname() else "localhost"
             endpoints = []
             for path in http_route_resource_information.paths:
-                endpoints.append(f"https://{self.get_hostname()}/{path.lstrip('/')}")
+                endpoints.append(f"{protocol}://{hostname}/{path.lstrip('/')}")
 
             self._gateway_route_provider.publish_endpoints(
                 endpoints,
diff --git a/gateway-api-integrator/src/resource_manager/gateway.py b/gateway-api-integrator/src/resource_manager/gateway.py
index 335ca3ff..585146d8 100644
--- a/gateway-api-integrator/src/resource_manager/gateway.py
+++ b/gateway-api-integrator/src/resource_manager/gateway.py
@@ -42,12 +42,14 @@ class GatewayResourceDefinition(ResourceDefinition):
         external_hostname: The configured gateway hostname.
         gateway_class_name: The configured gateway class.
         secret_resource_name_prefix: Prefix of the secret resource name.
+        enforce_https: Whether to enforce HTTPS by creating the HTTPS listener.
     """
 
     gateway_name: str
     external_hostname: str
     gateway_class_name: str
     secret_resource_name_prefix: str
+    enforce_https: bool
 
     def __init__(
         self,
@@ -103,6 +105,34 @@ def _gen_resource(self, resource_definition: ResourceDefinition) -> dict:
         gateway_resource_definition = typing.cast(GatewayResourceDefinition, resource_definition)
         prefix = gateway_resource_definition.secret_resource_name_prefix
         tls_secret_name = f"{prefix}-{gateway_resource_definition.external_hostname}"
+        
+        listeners = [
+            {
+                "protocol": "HTTP",
+                "port": 80,
+                "name": f"{gateway_resource_definition.gateway_name}-http-listener",
+                "allowedRoutes": {"namespaces": {"from": "All"}},
+            }
+        ]
+        
+        # Only add hostname to HTTP listener if one is configured
+        if gateway_resource_definition.external_hostname:
+            listeners[0]["hostname"] = gateway_resource_definition.external_hostname
+        
+        # Only add HTTPS listener if enforce_https is true
+        if gateway_resource_definition.enforce_https:
+            https_listener = {
+                "protocol": "HTTPS",
+                "port": 443,
+                "name": f"{gateway_resource_definition.gateway_name}-https-listener",
+                "allowedRoutes": {"namespaces": {"from": "All"}},
+                "tls": {"certificateRefs": [{"kind": "Secret", "name": tls_secret_name}]},
+            }
+            # Only add hostname to HTTPS listener if one is configured
+            if gateway_resource_definition.external_hostname:
+                https_listener["hostname"] = gateway_resource_definition.external_hostname
+            listeners.append(https_listener)
+        
         gateway = self._gateway_generic_resource(
             apiVersion="gateway.networking.k8s.io/v1",
             kind="Gateway",
@@ -111,23 +141,7 @@ def _gen_resource(self, resource_definition: ResourceDefinition) -> dict:
             ),
             spec={
                 "gatewayClassName": gateway_resource_definition.gateway_class_name,
-                "listeners": [
-                    {
-                        "protocol": "HTTP",
-                        "port": 80,
-                        "name": f"{gateway_resource_definition.gateway_name}-http-listener",
-                        "hostname": gateway_resource_definition.external_hostname,
-                        "allowedRoutes": {"namespaces": {"from": "All"}},
-                    },
-                    {
-                        "protocol": "HTTPS",
-                        "port": 443,
-                        "name": f"{gateway_resource_definition.gateway_name}-https-listener",
-                        "hostname": gateway_resource_definition.external_hostname,
-                        "allowedRoutes": {"namespaces": {"from": "All"}},
-                        "tls": {"certificateRefs": [{"kind": "Secret", "name": tls_secret_name}]},
-                    },
-                ],
+                "listeners": listeners,
             },
         )
         return gateway
diff --git a/gateway-api-integrator/src/state/config.py b/gateway-api-integrator/src/state/config.py
index 62cb1f50..22fb2425 100644
--- a/gateway-api-integrator/src/state/config.py
+++ b/gateway-api-integrator/src/state/config.py
@@ -39,12 +39,12 @@ class CharmConfig:
     Attributes:
         gateway_class_name: The configured gateway class.
         external_hostname: The configured gateway hostname.
+        enforce_https: Whether to enforce HTTPS by redirecting HTTP to HTTPS.
     """
 
     gateway_class_name: str = Field(min_length=1)
-    external_hostname: str = Field(
-        min_length=1, pattern=r"[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*"
-    )
+    external_hostname: str
+    enforce_https: bool
 
     @classmethod
     @map_k8s_auth_exception
@@ -87,10 +87,31 @@ def from_charm(cls, charm: ops.CharmBase, client: Client) -> "CharmConfig":
                 f"Gateway class must be one of: [{available_gateway_classes}]"
             )
 
+        enforce_https = typing.cast(bool, charm.config.get("enforce-https", True))
+        external_hostname = charm.get_hostname()  # type: ignore[attr-defined]
+
+        # Validate that hostname is provided when HTTPS is enforced
+        if enforce_https and not external_hostname:
+            raise InvalidCharmConfigError(
+                "external-hostname is required when enforce-https is true"
+            )
+
+        # Validate hostname format if provided
+        if external_hostname:
+            import re
+
+            hostname_pattern = r"^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$"
+            if not re.match(hostname_pattern, external_hostname):
+                raise InvalidCharmConfigError(
+                    "external-hostname must match pattern: "
+                    "[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*"
+                )
+
         try:
             return cls(
                 gateway_class_name=gateway_class_name,
-                external_hostname=charm.get_hostname(),  # type: ignore[attr-defined]
+                external_hostname=external_hostname,
+                enforce_https=enforce_https,
             )
         except ValidationError as exc:
             error_field_str = ",".join(f"{field}" for field in get_invalid_config_fields(exc))
diff --git a/gateway-api-integrator/src/state/tls.py b/gateway-api-integrator/src/state/tls.py
index 7e2af6b7..1cb0435d 100644
--- a/gateway-api-integrator/src/state/tls.py
+++ b/gateway-api-integrator/src/state/tls.py
@@ -33,18 +33,20 @@ class TLSInformation:
 
     @classmethod
     def from_charm(
-        cls, charm: ops.CharmBase, certificates: TLSCertificatesRequiresV4
+        cls, charm: ops.CharmBase, certificates: TLSCertificatesRequiresV4, validate: bool = True
     ) -> "TLSInformation":
         """Get TLS information from a charm instance.
 
         Args:
             charm: The gateway-api-integrator charm.
             certificates: TLS certificates requirer library.
+            validate: Whether to validate that certificates relation is ready. Default is True.
 
         Returns:
             TLSInformation: Information about configured TLS certs.
         """
-        cls.validate(charm)
+        if validate:
+            cls.validate(charm)
 
         tls_certs = {}
         tls_keys = {}

From 6f19207bed94f9ce5ce69246e8f0dabe12dffd19 Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Fri, 13 Feb 2026 10:20:23 +0000
Subject: [PATCH 06/32] Fix dataclass field ordering and update tests

Co-authored-by: Thanhphan1147 <42444001+Thanhphan1147@users.noreply.github.com>
---
 gateway-api-integrator/src/state/config.py             | 6 +++---
 gateway-api-integrator/tests/unit_scenario/conftest.py | 8 +++++++-
 2 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/gateway-api-integrator/src/state/config.py b/gateway-api-integrator/src/state/config.py
index 22fb2425..3d2934f6 100644
--- a/gateway-api-integrator/src/state/config.py
+++ b/gateway-api-integrator/src/state/config.py
@@ -43,8 +43,8 @@ class CharmConfig:
     """
 
     gateway_class_name: str = Field(min_length=1)
-    external_hostname: str
-    enforce_https: bool
+    enforce_https: bool = True
+    external_hostname: str = ""
 
     @classmethod
     @map_k8s_auth_exception
@@ -100,7 +100,7 @@ def from_charm(cls, charm: ops.CharmBase, client: Client) -> "CharmConfig":
         if external_hostname:
             import re
 
-            hostname_pattern = r"^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$"
+            hostname_pattern = r"^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$"
             if not re.match(hostname_pattern, external_hostname):
                 raise InvalidCharmConfigError(
                     "external-hostname must match pattern: "
diff --git a/gateway-api-integrator/tests/unit_scenario/conftest.py b/gateway-api-integrator/tests/unit_scenario/conftest.py
index ee8b07ea..c11337bc 100644
--- a/gateway-api-integrator/tests/unit_scenario/conftest.py
+++ b/gateway-api-integrator/tests/unit_scenario/conftest.py
@@ -21,7 +21,13 @@ def base_state_fixture(monkeypatch: pytest.MonkeyPatch):
     monkeypatch.setattr("client.Client", MagicMock())
     monkeypatch.setattr(
         "charm.CharmConfig.from_charm",
-        MagicMock(return_value=CharmConfig(GATEWAY_CLASS_CONFIG, TEST_EXTERNAL_HOSTNAME_CONFIG)),
+        MagicMock(
+            return_value=CharmConfig(
+                gateway_class_name=GATEWAY_CLASS_CONFIG,
+                external_hostname=TEST_EXTERNAL_HOSTNAME_CONFIG,
+                enforce_https=True,
+            )
+        ),
     )
     monkeypatch.setattr("charm.GatewayAPICharm._define_secret_resources", MagicMock())
     monkeypatch.setattr(

From 9fbffc72cd739b45eece6772b16e5cf45a287895 Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Fri, 13 Feb 2026 10:21:51 +0000
Subject: [PATCH 07/32] Add unit tests for enforce-https configuration option

Co-authored-by: Thanhphan1147 <42444001+Thanhphan1147@users.noreply.github.com>
---
 .../tests/unit/test_config.py                 | 124 +++++++++++++++
 .../tests/unit/test_gateway.py                | 142 ++++++++++++++++++
 2 files changed, 266 insertions(+)

diff --git a/gateway-api-integrator/tests/unit/test_config.py b/gateway-api-integrator/tests/unit/test_config.py
index 20d43562..a8777267 100644
--- a/gateway-api-integrator/tests/unit/test_config.py
+++ b/gateway-api-integrator/tests/unit/test_config.py
@@ -41,3 +41,127 @@ def test_config(harness: Harness, available_gateway_classes: str):
     harness.begin()
     with pytest.raises(InvalidCharmConfigError):
         _ = CharmConfig.from_charm(harness.charm, client_mock)
+
+
+def test_config_enforce_https_with_hostname(harness: Harness):
+    """
+    arrange: Given a charm with enforce-https enabled and a valid hostname.
+    act: Initialize the CharmConfig state component.
+    assert: CharmConfig is created successfully with enforce_https=True.
+    """
+    harness.update_config(
+        {
+            "gateway-class": GATEWAY_CLASS_CONFIG,
+            "external-hostname": "example.com",
+            "enforce-https": True,
+        }
+    )
+    client_mock = MagicMock(spec=Client)
+    client_mock.list = MagicMock(
+        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
+    )
+    harness.begin()
+    
+    config = CharmConfig.from_charm(harness.charm, client_mock)
+    
+    assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
+    assert config.external_hostname == "example.com"
+    assert config.enforce_https is True
+
+
+def test_config_enforce_https_false_without_hostname(harness: Harness):
+    """
+    arrange: Given a charm with enforce-https disabled and no hostname.
+    act: Initialize the CharmConfig state component.
+    assert: CharmConfig is created successfully with enforce_https=False and empty hostname.
+    """
+    harness.update_config(
+        {
+            "gateway-class": GATEWAY_CLASS_CONFIG,
+            "external-hostname": "",
+            "enforce-https": False,
+        }
+    )
+    client_mock = MagicMock(spec=Client)
+    client_mock.list = MagicMock(
+        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
+    )
+    harness.begin()
+    
+    config = CharmConfig.from_charm(harness.charm, client_mock)
+    
+    assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
+    assert config.external_hostname == ""
+    assert config.enforce_https is False
+
+
+def test_config_enforce_https_true_without_hostname(harness: Harness):
+    """
+    arrange: Given a charm with enforce-https enabled but no hostname.
+    act: Initialize the CharmConfig state component.
+    assert: InvalidCharmConfigError is raised.
+    """
+    harness.update_config(
+        {
+            "gateway-class": GATEWAY_CLASS_CONFIG,
+            "external-hostname": "",
+            "enforce-https": True,
+        }
+    )
+    client_mock = MagicMock(spec=Client)
+    client_mock.list = MagicMock(
+        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
+    )
+    harness.begin()
+    
+    with pytest.raises(InvalidCharmConfigError, match="external-hostname is required"):
+        _ = CharmConfig.from_charm(harness.charm, client_mock)
+
+
+def test_config_enforce_https_false_with_hostname(harness: Harness):
+    """
+    arrange: Given a charm with enforce-https disabled and a valid hostname.
+    act: Initialize the CharmConfig state component.
+    assert: CharmConfig is created successfully with enforce_https=False and hostname set.
+    """
+    harness.update_config(
+        {
+            "gateway-class": GATEWAY_CLASS_CONFIG,
+            "external-hostname": "example.com",
+            "enforce-https": False,
+        }
+    )
+    client_mock = MagicMock(spec=Client)
+    client_mock.list = MagicMock(
+        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
+    )
+    harness.begin()
+    
+    config = CharmConfig.from_charm(harness.charm, client_mock)
+    
+    assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
+    assert config.external_hostname == "example.com"
+    assert config.enforce_https is False
+
+
+def test_config_invalid_hostname_format(harness: Harness):
+    """
+    arrange: Given a charm with an invalid hostname format.
+    act: Initialize the CharmConfig state component.
+    assert: InvalidCharmConfigError is raised.
+    """
+    harness.update_config(
+        {
+            "gateway-class": GATEWAY_CLASS_CONFIG,
+            "external-hostname": "INVALID_HOSTNAME",
+            "enforce-https": False,
+        }
+    )
+    client_mock = MagicMock(spec=Client)
+    client_mock.list = MagicMock(
+        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
+    )
+    harness.begin()
+    
+    with pytest.raises(InvalidCharmConfigError, match="external-hostname must match pattern"):
+        _ = CharmConfig.from_charm(harness.charm, client_mock)
diff --git a/gateway-api-integrator/tests/unit/test_gateway.py b/gateway-api-integrator/tests/unit/test_gateway.py
index 08f31397..138550da 100644
--- a/gateway-api-integrator/tests/unit/test_gateway.py
+++ b/gateway-api-integrator/tests/unit/test_gateway.py
@@ -155,6 +155,148 @@ def test_gateway_gen_resource(
     assert len(gateway_resource.spec["listeners"])
 
 
+def test_gateway_gen_resource_enforce_https_true(
+    harness: Harness,
+    config: dict[str, str],
+    certificates_relation_data: dict[str, str],
+    client_with_mock_external: MagicMock,
+):
+    """
+    arrange: Given a charm with enforce-https enabled and valid config.
+    act: Call _gen_resource from the required state components.
+    assert: The Gateway resource has both HTTP and HTTPS listeners.
+    """
+    config_with_enforce_https = config.copy()
+    config_with_enforce_https["enforce-https"] = True
+    
+    relation_id = harness.add_relation("certificates", "self-signed-certificates")
+    harness.update_relation_data(relation_id, harness.model.app.name, certificates_relation_data)
+    harness.update_config(config_with_enforce_https)
+    harness.begin()
+
+    gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
+    gateway_resource_manager = GatewayResourceManager(
+        labels=harness.charm._labels,
+        client=client_with_mock_external,
+    )
+    tls_information = TLSInformation.from_charm(harness.charm, harness.charm.certificates)
+    charm_config = CharmConfig.from_charm(harness.charm, client_with_mock_external)
+    gateway_resource = gateway_resource_manager._gen_resource(
+        GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
+    )
+
+    assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
+    listeners = gateway_resource.spec["listeners"]
+    assert len(listeners) == 2
+    
+    # Check HTTP listener
+    http_listener = next(l for l in listeners if l["protocol"] == "HTTP")
+    assert http_listener["port"] == 80
+    assert "hostname" in http_listener
+    
+    # Check HTTPS listener
+    https_listener = next(l for l in listeners if l["protocol"] == "HTTPS")
+    assert https_listener["port"] == 443
+    assert "tls" in https_listener
+    assert "hostname" in https_listener
+
+
+def test_gateway_gen_resource_enforce_https_false(
+    harness: Harness,
+    client_with_mock_external: MagicMock,
+):
+    """
+    arrange: Given a charm with enforce-https disabled.
+    act: Call _gen_resource from the required state components.
+    assert: The Gateway resource has only HTTP listener, no HTTPS listener.
+    """
+    config_no_https = {
+        "gateway-class": GATEWAY_CLASS_CONFIG,
+        "external-hostname": "",
+        "enforce-https": False,
+    }
+    
+    harness.update_config(config_no_https)
+    harness.begin()
+
+    gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
+    gateway_resource_manager = GatewayResourceManager(
+        labels=harness.charm._labels,
+        client=client_with_mock_external,
+    )
+    # Don't validate TLS since enforce_https is False
+    tls_information = TLSInformation.from_charm(
+        harness.charm, harness.charm.certificates, validate=False
+    )
+    charm_config = CharmConfig.from_charm(harness.charm, client_with_mock_external)
+    gateway_resource = gateway_resource_manager._gen_resource(
+        GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
+    )
+
+    assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
+    listeners = gateway_resource.spec["listeners"]
+    assert len(listeners) == 1
+    
+    # Check only HTTP listener is present
+    http_listener = listeners[0]
+    assert http_listener["protocol"] == "HTTP"
+    assert http_listener["port"] == 80
+    # No hostname should be set when it's not provided
+    assert "hostname" not in http_listener
+    
+    # Verify no HTTPS listener
+    https_listeners = [l for l in listeners if l["protocol"] == "HTTPS"]
+    assert len(https_listeners) == 0
+
+
+def test_gateway_gen_resource_enforce_https_false_with_hostname(
+    harness: Harness,
+    client_with_mock_external: MagicMock,
+):
+    """
+    arrange: Given a charm with enforce-https disabled but with a hostname.
+    act: Call _gen_resource from the required state components.
+    assert: The Gateway resource has only HTTP listener with hostname set.
+    """
+    config_http_with_hostname = {
+        "gateway-class": GATEWAY_CLASS_CONFIG,
+        "external-hostname": "example.com",
+        "enforce-https": False,
+    }
+    
+    harness.update_config(config_http_with_hostname)
+    harness.begin()
+
+    gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
+    gateway_resource_manager = GatewayResourceManager(
+        labels=harness.charm._labels,
+        client=client_with_mock_external,
+    )
+    # Don't validate TLS since enforce_https is False
+    tls_information = TLSInformation.from_charm(
+        harness.charm, harness.charm.certificates, validate=False
+    )
+    charm_config = CharmConfig.from_charm(harness.charm, client_with_mock_external)
+    gateway_resource = gateway_resource_manager._gen_resource(
+        GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
+    )
+
+    assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
+    listeners = gateway_resource.spec["listeners"]
+    assert len(listeners) == 1
+    
+    # Check only HTTP listener is present with hostname
+    http_listener = listeners[0]
+    assert http_listener["protocol"] == "HTTP"
+    assert http_listener["port"] == 80
+    assert http_listener["hostname"] == "example.com"
+    
+    # Verify no HTTPS listener
+    https_listeners = [l for l in listeners if l["protocol"] == "HTTPS"]
+    assert len(https_listeners) == 0
+
+
+
 def test_get_current_gateway_no_resource(mock_lightkube_client: MagicMock):
     """
     arrange: Given an GatewayResourceManager with mocked lightkube client

From 23074dfb82cd82fae5adf836b1fdfdf724515220 Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Fri, 13 Feb 2026 10:25:56 +0000
Subject: [PATCH 08/32] Fix linting and type checking issues

Co-authored-by: Thanhphan1147 <42444001+Thanhphan1147@users.noreply.github.com>
---
 gateway-api-integrator/src/charm.py           | 12 +++---
 .../src/resource_manager/gateway.py           |  8 ++--
 .../tests/unit/test_config.py                 | 16 ++++----
 .../tests/unit/test_gateway.py                | 40 +++++++++----------
 4 files changed, 37 insertions(+), 39 deletions(-)

diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index 430e207b..a78da29f 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -246,12 +246,12 @@ def _reconcile(self) -> None:
         client = get_client(field_manager=self.app.name, namespace=self.model.name)
         config = CharmConfig.from_charm(self, client)
         gateway_resource_information = GatewayResourceInformation.from_charm(self)
-        
+
         # Only validate TLS information if HTTPS is enforced
         tls_information = TLSInformation.from_charm(
             self, self.certificates, validate=config.enforce_https
         )
-        
+
         self.unit.status = MaintenanceStatus("Creating resources.")
         resource_manager = GatewayResourceManager(
             labels=self._labels,
@@ -357,7 +357,7 @@ def _define_secret_resources(
             )
             resource_manager.cleanup_resources(exclude=[])
             return
-            
+
         resource_definition = SecretResourceDefinition.from_tls_information(
             tls_information, config.external_hostname
         )
@@ -390,7 +390,7 @@ def get_hostname(self) -> str:
         ):
             return typing.cast(str, self.model.config.get("external-hostname"))
 
-    def _define_ingress_resources_and_publish_url(
+    def _define_ingress_resources_and_publish_url(  # pylint: disable=too-many-locals
         self,
         client: Client,
         config: CharmConfig,
@@ -411,7 +411,7 @@ def _define_ingress_resources_and_publish_url(
             ServiceResourceDefinition(http_route_resource_information)
         )
         http_route_resource_manager = HTTPRouteResourceManager(self._labels, client)
-        
+
         if config.enforce_https:
             # When HTTPS is enforced, create both redirect and HTTPS routes
             redirect_resource_manager = HTTPRouteRedirectResourceManager(self._labels, client)
@@ -440,7 +440,7 @@ def _define_ingress_resources_and_publish_url(
                 )
             )
             http_route_resource_manager.cleanup_resources(exclude=[http_route])
-        
+
         service_resource_manager.cleanup_resources(exclude=[service])
         ingress_relation = self.model.get_relation(INGRESS_RELATION)
         if ingress_relation:
diff --git a/gateway-api-integrator/src/resource_manager/gateway.py b/gateway-api-integrator/src/resource_manager/gateway.py
index 585146d8..e8cefedb 100644
--- a/gateway-api-integrator/src/resource_manager/gateway.py
+++ b/gateway-api-integrator/src/resource_manager/gateway.py
@@ -105,7 +105,7 @@ def _gen_resource(self, resource_definition: ResourceDefinition) -> dict:
         gateway_resource_definition = typing.cast(GatewayResourceDefinition, resource_definition)
         prefix = gateway_resource_definition.secret_resource_name_prefix
         tls_secret_name = f"{prefix}-{gateway_resource_definition.external_hostname}"
-        
+
         listeners = [
             {
                 "protocol": "HTTP",
@@ -114,11 +114,11 @@ def _gen_resource(self, resource_definition: ResourceDefinition) -> dict:
                 "allowedRoutes": {"namespaces": {"from": "All"}},
             }
         ]
-        
+
         # Only add hostname to HTTP listener if one is configured
         if gateway_resource_definition.external_hostname:
             listeners[0]["hostname"] = gateway_resource_definition.external_hostname
-        
+
         # Only add HTTPS listener if enforce_https is true
         if gateway_resource_definition.enforce_https:
             https_listener = {
@@ -132,7 +132,7 @@ def _gen_resource(self, resource_definition: ResourceDefinition) -> dict:
             if gateway_resource_definition.external_hostname:
                 https_listener["hostname"] = gateway_resource_definition.external_hostname
             listeners.append(https_listener)
-        
+
         gateway = self._gateway_generic_resource(
             apiVersion="gateway.networking.k8s.io/v1",
             kind="Gateway",
diff --git a/gateway-api-integrator/tests/unit/test_config.py b/gateway-api-integrator/tests/unit/test_config.py
index a8777267..8b513d81 100644
--- a/gateway-api-integrator/tests/unit/test_config.py
+++ b/gateway-api-integrator/tests/unit/test_config.py
@@ -61,9 +61,9 @@ def test_config_enforce_https_with_hostname(harness: Harness):
         return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
     )
     harness.begin()
-    
+
     config = CharmConfig.from_charm(harness.charm, client_mock)
-    
+
     assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
     assert config.external_hostname == "example.com"
     assert config.enforce_https is True
@@ -87,9 +87,9 @@ def test_config_enforce_https_false_without_hostname(harness: Harness):
         return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
     )
     harness.begin()
-    
+
     config = CharmConfig.from_charm(harness.charm, client_mock)
-    
+
     assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
     assert config.external_hostname == ""
     assert config.enforce_https is False
@@ -113,7 +113,7 @@ def test_config_enforce_https_true_without_hostname(harness: Harness):
         return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
     )
     harness.begin()
-    
+
     with pytest.raises(InvalidCharmConfigError, match="external-hostname is required"):
         _ = CharmConfig.from_charm(harness.charm, client_mock)
 
@@ -136,9 +136,9 @@ def test_config_enforce_https_false_with_hostname(harness: Harness):
         return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
     )
     harness.begin()
-    
+
     config = CharmConfig.from_charm(harness.charm, client_mock)
-    
+
     assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
     assert config.external_hostname == "example.com"
     assert config.enforce_https is False
@@ -162,6 +162,6 @@ def test_config_invalid_hostname_format(harness: Harness):
         return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
     )
     harness.begin()
-    
+
     with pytest.raises(InvalidCharmConfigError, match="external-hostname must match pattern"):
         _ = CharmConfig.from_charm(harness.charm, client_mock)
diff --git a/gateway-api-integrator/tests/unit/test_gateway.py b/gateway-api-integrator/tests/unit/test_gateway.py
index 138550da..03883181 100644
--- a/gateway-api-integrator/tests/unit/test_gateway.py
+++ b/gateway-api-integrator/tests/unit/test_gateway.py
@@ -166,12 +166,11 @@ def test_gateway_gen_resource_enforce_https_true(
     act: Call _gen_resource from the required state components.
     assert: The Gateway resource has both HTTP and HTTPS listeners.
     """
-    config_with_enforce_https = config.copy()
-    config_with_enforce_https["enforce-https"] = True
-    
+    config_with_enforce_https: dict[str, str | bool] = {**config, "enforce-https": True}
+
     relation_id = harness.add_relation("certificates", "self-signed-certificates")
     harness.update_relation_data(relation_id, harness.model.app.name, certificates_relation_data)
-    harness.update_config(config_with_enforce_https)
+    harness.update_config(config_with_enforce_https)  # type: ignore[arg-type]
     harness.begin()
 
     gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
@@ -188,14 +187,14 @@ def test_gateway_gen_resource_enforce_https_true(
     assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
     listeners = gateway_resource.spec["listeners"]
     assert len(listeners) == 2
-    
+
     # Check HTTP listener
-    http_listener = next(l for l in listeners if l["protocol"] == "HTTP")
+    http_listener = next(listener for listener in listeners if listener["protocol"] == "HTTP")
     assert http_listener["port"] == 80
     assert "hostname" in http_listener
-    
+
     # Check HTTPS listener
-    https_listener = next(l for l in listeners if l["protocol"] == "HTTPS")
+    https_listener = next(listener for listener in listeners if listener["protocol"] == "HTTPS")
     assert https_listener["port"] == 443
     assert "tls" in https_listener
     assert "hostname" in https_listener
@@ -210,13 +209,13 @@ def test_gateway_gen_resource_enforce_https_false(
     act: Call _gen_resource from the required state components.
     assert: The Gateway resource has only HTTP listener, no HTTPS listener.
     """
-    config_no_https = {
+    config_no_https: dict[str, str | bool] = {
         "gateway-class": GATEWAY_CLASS_CONFIG,
         "external-hostname": "",
         "enforce-https": False,
     }
-    
-    harness.update_config(config_no_https)
+
+    harness.update_config(config_no_https)  # type: ignore[arg-type]
     harness.begin()
 
     gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
@@ -236,16 +235,16 @@ def test_gateway_gen_resource_enforce_https_false(
     assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
     listeners = gateway_resource.spec["listeners"]
     assert len(listeners) == 1
-    
+
     # Check only HTTP listener is present
     http_listener = listeners[0]
     assert http_listener["protocol"] == "HTTP"
     assert http_listener["port"] == 80
     # No hostname should be set when it's not provided
     assert "hostname" not in http_listener
-    
+
     # Verify no HTTPS listener
-    https_listeners = [l for l in listeners if l["protocol"] == "HTTPS"]
+    https_listeners = [listener for listener in listeners if listener["protocol"] == "HTTPS"]
     assert len(https_listeners) == 0
 
 
@@ -258,13 +257,13 @@ def test_gateway_gen_resource_enforce_https_false_with_hostname(
     act: Call _gen_resource from the required state components.
     assert: The Gateway resource has only HTTP listener with hostname set.
     """
-    config_http_with_hostname = {
+    config_http_with_hostname: dict[str, str | bool] = {
         "gateway-class": GATEWAY_CLASS_CONFIG,
         "external-hostname": "example.com",
         "enforce-https": False,
     }
-    
-    harness.update_config(config_http_with_hostname)
+
+    harness.update_config(config_http_with_hostname)  # type: ignore[arg-type]
     harness.begin()
 
     gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
@@ -284,19 +283,18 @@ def test_gateway_gen_resource_enforce_https_false_with_hostname(
     assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
     listeners = gateway_resource.spec["listeners"]
     assert len(listeners) == 1
-    
+
     # Check only HTTP listener is present with hostname
     http_listener = listeners[0]
     assert http_listener["protocol"] == "HTTP"
     assert http_listener["port"] == 80
     assert http_listener["hostname"] == "example.com"
-    
+
     # Verify no HTTPS listener
-    https_listeners = [l for l in listeners if l["protocol"] == "HTTPS"]
+    https_listeners = [listener for listener in listeners if listener["protocol"] == "HTTPS"]
     assert len(https_listeners) == 0
 
 
-
 def test_get_current_gateway_no_resource(mock_lightkube_client: MagicMock):
     """
     arrange: Given an GatewayResourceManager with mocked lightkube client

From 53bc72adb69702289d6de4859f4b003089793e55 Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Fri, 13 Feb 2026 10:27:26 +0000
Subject: [PATCH 09/32] Address code review feedback - move import to module
 level and fix redundant calls

Co-authored-by: Thanhphan1147 <42444001+Thanhphan1147@users.noreply.github.com>
---
 gateway-api-integrator/src/charm.py        | 3 ++-
 gateway-api-integrator/src/state/config.py | 3 +--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index a78da29f..b53544da 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -459,7 +459,8 @@ def _define_ingress_resources_and_publish_url(  # pylint: disable=too-many-local
 
         if gateway_route_relation := self.model.get_relation(GATEWAY_ROUTE_RELATION):
             protocol = "https" if config.enforce_https else "http"
-            hostname = self.get_hostname() if self.get_hostname() else "localhost"
+            hostname_value = self.get_hostname()
+            hostname = hostname_value if hostname_value else "localhost"
             endpoints = []
             for path in http_route_resource_information.paths:
                 endpoints.append(f"{protocol}://{hostname}/{path.lstrip('/')}")
diff --git a/gateway-api-integrator/src/state/config.py b/gateway-api-integrator/src/state/config.py
index 3d2934f6..76f4ae69 100644
--- a/gateway-api-integrator/src/state/config.py
+++ b/gateway-api-integrator/src/state/config.py
@@ -5,6 +5,7 @@
 
 import itertools
 import logging
+import re
 import typing
 
 import ops
@@ -98,8 +99,6 @@ def from_charm(cls, charm: ops.CharmBase, client: Client) -> "CharmConfig":
 
         # Validate hostname format if provided
         if external_hostname:
-            import re
-
             hostname_pattern = r"^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$"
             if not re.match(hostname_pattern, external_hostname):
                 raise InvalidCharmConfigError(

From 75691c731f45bc8b36148578e56bab5ce13c8ea5 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 18 Feb 2026 17:18:24 +0100
Subject: [PATCH 10/32] use validators and improve parsing of config option

---
 .../v0/gateway_route.py                       | 26 +++++++--
 gateway-api-integrator/pyproject.toml         |  1 +
 gateway-api-integrator/src/state/config.py    | 21 ++-----
 gateway-api-integrator/uv.lock                | 11 ++++
 gateway-route-configurator/pyproject.toml     | 58 ++++++++++++-------
 gateway-route-configurator/uv.lock            | 11 ++++
 6 files changed, 89 insertions(+), 39 deletions(-)

diff --git a/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index cd7f7430..41951e93 100644
--- a/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -74,14 +74,15 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 import json
 import logging
-from typing import Any, MutableMapping, Optional, cast
+from typing import Annotated, Any, MutableMapping, Optional, cast
 
 from ops import CharmBase, ModelError, RelationBrokenEvent
 from ops.charm import CharmEvents
 from ops.framework import EventBase, EventSource, Object
 from ops.model import Relation
-from pydantic import AnyHttpUrl, BaseModel, ConfigDict, Field, ValidationError
+from pydantic import AnyHttpUrl, BaseModel, BeforeValidator, ConfigDict, Field, ValidationError
 from pydantic.dataclasses import dataclass
+from validators import domain
 
 # The unique Charmhub library identifier, never change it
 LIBID = "53fdf90019a7406695064ed1e3d2708f"
@@ -91,7 +92,7 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 # Increment this PATCH version before using `charmcraft publish-lib` or reset
 # to 0 if you are raising the major API version
-LIBPATCH = 1
+LIBPATCH = 2
 
 logger = logging.getLogger(__name__)
 GATEWAY_ROUTE_RELATION_NAME = "gateway-route"
@@ -211,6 +212,21 @@ def dump(
         return databag
 
 
+def valid_fqdn(value: str) -> str:
+    """Validate if value is a valid fqdn. TLDs are not allowed.
+
+    Raises:
+        ValueError: When value is not a valid domain.
+
+    Args:
+        value: The value to validate.
+    """
+    fqdn = value[2:] if value.startswith("*.") else value
+    if not bool(domain(fqdn)):
+        raise ValueError(f"Invalid domain: {value}")
+    return value
+
+
 class RequirerApplicationData(_DatabagModel):
     """Configuration model for Gateway route requirer application data.
 
@@ -222,7 +238,9 @@ class RequirerApplicationData(_DatabagModel):
         port: The port number on which the service is listening.
     """
 
-    hostname: str | None = Field(description="Hostname of this service.")
+    hostname: Annotated[str, BeforeValidator(valid_fqdn)] | None = Field(
+        description="Hostname of this service."
+    )
     paths: list[str] = Field(description="The list of paths to route to this service.", default=[])
     model: str = Field(description="The model the application is in.")
     name: str = Field(description="The name of the app requesting gateway route.")
diff --git a/gateway-api-integrator/pyproject.toml b/gateway-api-integrator/pyproject.toml
index 3b4a8c06..15af6b3d 100644
--- a/gateway-api-integrator/pyproject.toml
+++ b/gateway-api-integrator/pyproject.toml
@@ -20,6 +20,7 @@ dependencies = [
   "ops==3.5.2",
   "pydantic==2.12.5",
   "rpds-py==0.30.0",
+  "validators==0.35.0",
 ]
 
 [dependency-groups]
diff --git a/gateway-api-integrator/src/state/config.py b/gateway-api-integrator/src/state/config.py
index 76f4ae69..d219fdbe 100644
--- a/gateway-api-integrator/src/state/config.py
+++ b/gateway-api-integrator/src/state/config.py
@@ -5,13 +5,13 @@
 
 import itertools
 import logging
-import re
 import typing
 
 import ops
+from charms.gateway_api_integrator.v0.gateway_route import valid_fqdn
 from lightkube import Client
 from lightkube.generic_resource import create_global_resource
-from pydantic import Field, ValidationError
+from pydantic import BeforeValidator, Field, ValidationError
 from pydantic.dataclasses import dataclass
 
 from resource_manager.permission import map_k8s_auth_exception
@@ -43,9 +43,9 @@ class CharmConfig:
         enforce_https: Whether to enforce HTTPS by redirecting HTTP to HTTPS.
     """
 
+    external_hostname: typing.Annotated[str, BeforeValidator(valid_fqdn)] | None
     gateway_class_name: str = Field(min_length=1)
-    enforce_https: bool = True
-    external_hostname: str = ""
+    enforce_https: bool = Field()
 
     @classmethod
     @map_k8s_auth_exception
@@ -57,7 +57,7 @@ def from_charm(cls, charm: ops.CharmBase, client: Client) -> "CharmConfig":
             client: The lightkube client
 
         Raises:
-            InvalidCharmConfigError: When the chamr's config is invalid.
+            InvalidCharmConfigError: When the charm's config is invalid.
             GatewayClassUnavailableError: When the cluster has no available gateway classes.
 
         Returns:
@@ -89,7 +89,7 @@ def from_charm(cls, charm: ops.CharmBase, client: Client) -> "CharmConfig":
             )
 
         enforce_https = typing.cast(bool, charm.config.get("enforce-https", True))
-        external_hostname = charm.get_hostname()  # type: ignore[attr-defined]
+        external_hostname = typing.cast(str | None, charm.config.get("external-hostname"))
 
         # Validate that hostname is provided when HTTPS is enforced
         if enforce_https and not external_hostname:
@@ -97,15 +97,6 @@ def from_charm(cls, charm: ops.CharmBase, client: Client) -> "CharmConfig":
                 "external-hostname is required when enforce-https is true"
             )
 
-        # Validate hostname format if provided
-        if external_hostname:
-            hostname_pattern = r"^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$"
-            if not re.match(hostname_pattern, external_hostname):
-                raise InvalidCharmConfigError(
-                    "external-hostname must match pattern: "
-                    "[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*"
-                )
-
         try:
             return cls(
                 gateway_class_name=gateway_class_name,
diff --git a/gateway-api-integrator/uv.lock b/gateway-api-integrator/uv.lock
index 56a955d3..e5661ba0 100644
--- a/gateway-api-integrator/uv.lock
+++ b/gateway-api-integrator/uv.lock
@@ -485,6 +485,7 @@ dependencies = [
     { name = "ops" },
     { name = "pydantic" },
     { name = "rpds-py" },
+    { name = "validators" },
 ]
 
 [package.dev-dependencies]
@@ -531,6 +532,7 @@ requires-dist = [
     { name = "ops", specifier = "==3.5.2" },
     { name = "pydantic", specifier = "==2.12.5" },
     { name = "rpds-py", specifier = "==0.30.0" },
+    { name = "validators", specifier = "==0.35.0" },
 ]
 
 [package.metadata.requires-dev]
@@ -1873,6 +1875,15 @@ wheels = [
     { url = "https://files.pythonhosted.org/packages/a7/c2/fe1e52489ae3122415c51f387e221dd0773709bad6c6cdaa599e8a2c5185/urllib3-2.5.0-py3-none-any.whl", hash = "sha256:e6b01673c0fa6a13e374b50871808eb3bf7046c4b125b216f6bf1cc604cff0dc", size = 129795, upload-time = "2025-06-18T14:07:40.39Z" },
 ]
 
+[[package]]
+name = "validators"
+version = "0.35.0"
+source = { registry = "https://pypi.org/simple" }
+sdist = { url = "https://files.pythonhosted.org/packages/53/66/a435d9ae49850b2f071f7ebd8119dd4e84872b01630d6736761e6e7fd847/validators-0.35.0.tar.gz", hash = "sha256:992d6c48a4e77c81f1b4daba10d16c3a9bb0dbb79b3a19ea847ff0928e70497a", size = 73399, upload-time = "2025-05-01T05:42:06.7Z" }
+wheels = [
+    { url = "https://files.pythonhosted.org/packages/fa/6e/3e955517e22cbdd565f2f8b2e73d52528b14b8bcfdb04f62466b071de847/validators-0.35.0-py3-none-any.whl", hash = "sha256:e8c947097eae7892cb3d26868d637f79f47b4a0554bc6b80065dfe5aac3705dd", size = 44712, upload-time = "2025-05-01T05:42:04.203Z" },
+]
+
 [[package]]
 name = "wcwidth"
 version = "0.6.0"
diff --git a/gateway-route-configurator/pyproject.toml b/gateway-route-configurator/pyproject.toml
index e64f065b..e6b6fbf2 100644
--- a/gateway-route-configurator/pyproject.toml
+++ b/gateway-route-configurator/pyproject.toml
@@ -21,12 +21,11 @@ dependencies = [
   "pydantic==2.12.5",
   "pytest>=9.0.1",
   "rpds-py==0.30.0",
+  "validators==0.35.0",
 ]
 
 [dependency-groups]
-fmt = [
-  "ruff",
-]
+fmt = ["ruff"]
 lint = [
   "codespell",
   "jubilant==1.7.0",
@@ -38,18 +37,9 @@ lint = [
   "types-pyyaml",
   "types-requests",
 ]
-unit = [
-  "coverage[toml]",
-  "ops[testing]",
-  "pytest",
-]
-coverage-report = [
-  "coverage[toml]",
-  "pytest",
-]
-static = [
-  "bandit[toml]",
-]
+unit = ["coverage[toml]", "ops[testing]", "pytest"]
+coverage-report = ["coverage[toml]", "pytest"]
+static = ["bandit[toml]"]
 integration = [
   "allure-pytest>=2.8.18",
   "allure-pytest-collection-report @ git+https://github.com/canonical/data-platform-workflows@v24.0.0#subdirectory=python/pytest_plugins/allure_pytest_collection_report",
@@ -78,7 +68,23 @@ line-length = 99
 #  UP pyupgrade
 # RUF Ruff-specific rules
 # E/W pycodestyle
-lint.select = [ "A", "B", "C", "CPY", "D", "E", "F", "I", "N", "RUF", "S", "SIM", "TC", "UP", "W" ]
+lint.select = [
+  "A",
+  "B",
+  "C",
+  "CPY",
+  "D",
+  "E",
+  "F",
+  "I",
+  "N",
+  "RUF",
+  "S",
+  "SIM",
+  "TC",
+  "UP",
+  "W",
+]
 lint.ignore = [
   "B904",
   "D107",
@@ -104,7 +110,19 @@ lint.ignore = [
   "UP035",
   "UP045",
 ]
-lint.per-file-ignores."tests/*" = [ "B011", "D100", "D101", "D102", "D103", "D104", "D205", "D212", "D415", "D417", "S" ]
+lint.per-file-ignores."tests/*" = [
+  "B011",
+  "D100",
+  "D101",
+  "D102",
+  "D103",
+  "D104",
+  "D205",
+  "D212",
+  "D415",
+  "D417",
+  "S",
+]
 lint.flake8-copyright.author = "Canonical Ltd."
 lint.flake8-copyright.min-file-size = 1
 lint.flake8-copyright.notice-rgx = "Copyright\\s\\d{4}([-,]\\d{4})*\\s+"
@@ -117,7 +135,7 @@ skip = "build,lib,venv,icon.svg,.tox,.git,.mypy_cache,.ruff_cache,.coverage,html
 [tool.pytest.ini_options]
 minversion = "6.0"
 log_cli_level = "INFO"
-pythonpath = [ "lib", "src" ]
+pythonpath = ["lib", "src"]
 
 [tool.coverage.run]
 branch = true
@@ -137,7 +155,7 @@ module = "tests.*"
 disallow_untyped_defs = false
 
 [tool.bandit]
-exclude_dirs = [ "/venv/" ]
+exclude_dirs = ["/venv/"]
 
 [tool.bandit.assert_used]
-skips = [ "*/*test.py", "*/test_*.py", "*tests/*.py" ]
+skips = ["*/*test.py", "*/test_*.py", "*tests/*.py"]
diff --git a/gateway-route-configurator/uv.lock b/gateway-route-configurator/uv.lock
index 8ea1ef71..1cb2b41d 100644
--- a/gateway-route-configurator/uv.lock
+++ b/gateway-route-configurator/uv.lock
@@ -378,6 +378,7 @@ dependencies = [
     { name = "pydantic" },
     { name = "pytest" },
     { name = "rpds-py" },
+    { name = "validators" },
 ]
 
 [package.dev-dependencies]
@@ -423,6 +424,7 @@ requires-dist = [
     { name = "pydantic", specifier = "==2.12.5" },
     { name = "pytest", specifier = ">=9.0.1" },
     { name = "rpds-py", specifier = "==0.30.0" },
+    { name = "validators", specifier = "==0.35.0" },
 ]
 
 [package.metadata.requires-dev]
@@ -1178,6 +1180,15 @@ wheels = [
     { url = "https://files.pythonhosted.org/packages/a7/c2/fe1e52489ae3122415c51f387e221dd0773709bad6c6cdaa599e8a2c5185/urllib3-2.5.0-py3-none-any.whl", hash = "sha256:e6b01673c0fa6a13e374b50871808eb3bf7046c4b125b216f6bf1cc604cff0dc", size = 129795, upload-time = "2025-06-18T14:07:40.39Z" },
 ]
 
+[[package]]
+name = "validators"
+version = "0.35.0"
+source = { registry = "https://pypi.org/simple" }
+sdist = { url = "https://files.pythonhosted.org/packages/53/66/a435d9ae49850b2f071f7ebd8119dd4e84872b01630d6736761e6e7fd847/validators-0.35.0.tar.gz", hash = "sha256:992d6c48a4e77c81f1b4daba10d16c3a9bb0dbb79b3a19ea847ff0928e70497a", size = 73399, upload-time = "2025-05-01T05:42:06.7Z" }
+wheels = [
+    { url = "https://files.pythonhosted.org/packages/fa/6e/3e955517e22cbdd565f2f8b2e73d52528b14b8bcfdb04f62466b071de847/validators-0.35.0-py3-none-any.whl", hash = "sha256:e8c947097eae7892cb3d26868d637f79f47b4a0554bc6b80065dfe5aac3705dd", size = 44712, upload-time = "2025-05-01T05:42:04.203Z" },
+]
+
 [[package]]
 name = "websocket-client"
 version = "1.9.0"

From 900acd51bb10e58ae86d121ac14cf838fea2227e Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 18 Feb 2026 17:19:21 +0100
Subject: [PATCH 11/32] bump lib for gateway-route configurator

---
 .../v0/gateway_route.py                       | 26 ++++++++++++++++---
 1 file changed, 22 insertions(+), 4 deletions(-)

diff --git a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index cd7f7430..41951e93 100644
--- a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -74,14 +74,15 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 import json
 import logging
-from typing import Any, MutableMapping, Optional, cast
+from typing import Annotated, Any, MutableMapping, Optional, cast
 
 from ops import CharmBase, ModelError, RelationBrokenEvent
 from ops.charm import CharmEvents
 from ops.framework import EventBase, EventSource, Object
 from ops.model import Relation
-from pydantic import AnyHttpUrl, BaseModel, ConfigDict, Field, ValidationError
+from pydantic import AnyHttpUrl, BaseModel, BeforeValidator, ConfigDict, Field, ValidationError
 from pydantic.dataclasses import dataclass
+from validators import domain
 
 # The unique Charmhub library identifier, never change it
 LIBID = "53fdf90019a7406695064ed1e3d2708f"
@@ -91,7 +92,7 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 # Increment this PATCH version before using `charmcraft publish-lib` or reset
 # to 0 if you are raising the major API version
-LIBPATCH = 1
+LIBPATCH = 2
 
 logger = logging.getLogger(__name__)
 GATEWAY_ROUTE_RELATION_NAME = "gateway-route"
@@ -211,6 +212,21 @@ def dump(
         return databag
 
 
+def valid_fqdn(value: str) -> str:
+    """Validate if value is a valid fqdn. TLDs are not allowed.
+
+    Raises:
+        ValueError: When value is not a valid domain.
+
+    Args:
+        value: The value to validate.
+    """
+    fqdn = value[2:] if value.startswith("*.") else value
+    if not bool(domain(fqdn)):
+        raise ValueError(f"Invalid domain: {value}")
+    return value
+
+
 class RequirerApplicationData(_DatabagModel):
     """Configuration model for Gateway route requirer application data.
 
@@ -222,7 +238,9 @@ class RequirerApplicationData(_DatabagModel):
         port: The port number on which the service is listening.
     """
 
-    hostname: str | None = Field(description="Hostname of this service.")
+    hostname: Annotated[str, BeforeValidator(valid_fqdn)] | None = Field(
+        description="Hostname of this service."
+    )
     paths: list[str] = Field(description="The list of paths to route to this service.", default=[])
     model: str = Field(description="The model the application is in.")
     name: str = Field(description="The name of the app requesting gateway route.")

From 422633fbccab54f07d1e64d0598cbf14df1887e6 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 18 Feb 2026 17:30:35 +0100
Subject: [PATCH 12/32] update init of httproute resource information

---
 gateway-api-integrator/src/charm.py | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index b53544da..c7f342c1 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -377,9 +377,10 @@ def get_hostname(self) -> str:
         try:
             if not self.model.get_relation(GATEWAY_ROUTE_RELATION):
                 return typing.cast(str, self.model.config.get("external-hostname"))
-
-            http_route_resource_information = HTTPRouteResourceInformation.from_charm(
-                self, self._ingress_provider, self._gateway_route_provider
+            client = get_client(field_manager=self.app.name, namespace=self.model.name)
+            config = CharmConfig.from_charm(self, client)
+            http_route_resource_information = HTTPRouteResourceInformation.from_provider(
+                config.external_hostname, self._ingress_provider, self._gateway_route_provider
             )
             return http_route_resource_information.hostname
         except (
@@ -403,8 +404,8 @@ def _define_ingress_resources_and_publish_url(  # pylint: disable=too-many-local
             config: Charm config.
             gateway_resource_information: Information needed to attach http_route resources.
         """
-        http_route_resource_information = HTTPRouteResourceInformation.from_charm(
-            self, self._ingress_provider, self._gateway_route_provider
+        http_route_resource_information = HTTPRouteResourceInformation.from_provider(
+            config.external_hostname, self._ingress_provider, self._gateway_route_provider
         )
         service_resource_manager = ServiceResourceManager(self._labels, client)
         service = service_resource_manager.define_resource(

From be606fb3cd650ea248570a51cd8a74da7df87a89 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 10:06:10 +0100
Subject: [PATCH 13/32] bootstrap logic for enforce_https

---
 .../v0/gateway_route.py                       |  13 +-
 gateway-api-integrator/src/charm.py           | 182 ++++++++++++------
 .../src/resource_manager/gateway.py           |  37 ++--
 .../src/resource_manager/http_route.py        | 169 ++++++++--------
 gateway-api-integrator/src/state/base.py      |  12 +-
 gateway-api-integrator/src/state/config.py    |  65 ++++++-
 gateway-api-integrator/src/state/gateway.py   |   1 -
 .../src/state/http_route.py                   | 165 +++++++---------
 gateway-api-integrator/src/state/tls.py       |  41 ++--
 .../src/state/validation.py                   |   3 +-
 .../tests/unit/test_config.py                 |  12 +-
 .../tests/unit/test_gateway.py                |   8 +-
 .../tests/unit/test_http_route.py             |  16 --
 .../tests/unit_scenario/conftest.py           |   5 +-
 14 files changed, 401 insertions(+), 328 deletions(-)

diff --git a/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index 41951e93..106108be 100644
--- a/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -354,7 +354,7 @@ def _on_endpoint_removed(self, _: EventBase) -> None:
         """Handle relation broken/departed events."""
         self.on.data_removed.emit()
 
-    def get_data(self, relation: Relation) -> Optional[GatewayRouteRequirerData]:
+    def get_data(self, relation: Relation | None = None) -> GatewayRouteRequirerData | None:
         """Fetch requirer data.
 
         Args:
@@ -366,12 +366,11 @@ def get_data(self, relation: Relation) -> Optional[GatewayRouteRequirerData]:
         Returns:
             GatewayRouteRequirerData: Validated data from the gateway-route requirer.
         """
-        requirer_data: Optional[GatewayRouteRequirerData] = None
-        if relation:
+        if requirer_relation := relation or self.relation:
             try:
-                application_data = self._get_requirer_application_data(relation)
-                requirer_data = GatewayRouteRequirerData(
-                    relation_id=relation.id,
+                application_data = self._get_requirer_application_data(requirer_relation)
+                return GatewayRouteRequirerData(
+                    relation_id=requirer_relation.id,
                     application_data=application_data,
                 )
             except DataValidationError as exc:
@@ -384,7 +383,7 @@ def get_data(self, relation: Relation) -> Optional[GatewayRouteRequirerData]:
                     raise GatewayRouteInvalidRelationDataError(
                         f"gateway-route data validation failed for relation: {relation}"
                     ) from exc
-        return requirer_data
+        return None
 
     def _get_requirer_application_data(self, relation: Relation) -> RequirerApplicationData:
         """Fetch and validate the requirer's application databag.
diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index c7f342c1..a20d2b22 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -42,18 +42,19 @@
 from client import get_client
 from resource_manager.gateway import GatewayResourceDefinition, GatewayResourceManager
 from resource_manager.http_route import (
-    HTTPRouteRedirectResourceManager,
     HTTPRouteResourceDefinition,
     HTTPRouteResourceManager,
     HTTPRouteType,
 )
 from resource_manager.secret import SecretResourceDefinition, TLSSecretResourceManager
 from resource_manager.service import ServiceResourceDefinition, ServiceResourceManager
-from state.config import CharmConfig
+from state.config import CharmConfig, IngressGatewayRouteConflictError, ProxyMode
 from state.gateway import GatewayResourceInformation
 from state.http_route import (
+    GatewayRouteHostnameMissingError,
+    GatewayRouteRelationDataValidationError,
+    GatewayRouteRelationNotReadyError,
     HTTPRouteResourceInformation,
-    IngressGatewayRouteConflictError,
     IngressIntegrationDataValidationError,
     IngressIntegrationMissingError,
 )
@@ -243,31 +244,36 @@ def _reconcile(self) -> None:
             5. Update the DNS record relation with the DNS record data
             6. Set the gateway LB address in the charm's status message.
         """
-        client = get_client(field_manager=self.app.name, namespace=self.model.name)
-        config = CharmConfig.from_charm(self, client)
-        gateway_resource_information = GatewayResourceInformation.from_charm(self)
+        self.unit.status = MaintenanceStatus("Creating resources.")
 
-        # Only validate TLS information if HTTPS is enforced
+        # Validate/parse TLS information and create TLS secret resources.
+        client = get_client(field_manager=self.app.name, namespace=self.model.name)
+        config = CharmConfig.from_charm_and_providers(
+            self, client, self._ingress_provider, self._gateway_route_provider
+        )
         tls_information = TLSInformation.from_charm(
-            self, self.certificates, validate=config.enforce_https
+            self, config, self.certificates, self._gateway_route_provider
         )
+        self._define_secret_resources(client, tls_information)
 
-        self.unit.status = MaintenanceStatus("Creating resources.")
-        resource_manager = GatewayResourceManager(
+        # Define gateway and HTTPRoute resources.
+        gateway_resource_information = GatewayResourceInformation.from_charm(self)
+        gateway_resource_manager = GatewayResourceManager(
             labels=self._labels,
             client=client,
         )
         self._define_gateway_resource(
-            resource_manager, gateway_resource_information, config, tls_information
+            gateway_resource_manager, gateway_resource_information, config, tls_information
         )
-        self._define_secret_resources(client, config, tls_information)
         self._define_ingress_resources_and_publish_url(
-            client, config, gateway_resource_information
+            client, config, tls_information, gateway_resource_information, gateway_resource_manager
         )
+
+        # Update DNS record relation with the gateway address.
         self._update_dns_record_relation(
-            resource_manager, config.external_hostname, gateway_resource_information
+            gateway_resource_manager, config.external_hostname, gateway_resource_information
         )
-        self._set_status_gateway_address(resource_manager, gateway_resource_information)
+        self._set_status_gateway_address(gateway_resource_manager, gateway_resource_information)
 
     def _update_dns_record_relation(
         self,
@@ -327,6 +333,7 @@ def _define_gateway_resource(
             resource_manager: The Gateway resource manager to define the gateway resource.
             gateway_resource_information: Information needed to create the gateway resource.
             config: Charm config.
+            hostname: External hostname for the gateway.
             tls_information: Information needed to create TLS secret resources.
         """
         resource_definition = GatewayResourceDefinition(
@@ -338,19 +345,17 @@ def _define_gateway_resource(
     def _define_secret_resources(
         self,
         client: Client,
-        config: CharmConfig,
         tls_information: TLSInformation,
     ) -> None:
         """Define TLS secret resources.
 
         Args:
             client: Lightkube client.
-            config: Charm config.
             tls_information: TLS-related information needed to create secret resources.
         """
         # Only create TLS secrets when HTTPS is enforced
-        if not config.enforce_https:
-            # Clean up any existing secrets if HTTPS is not enforced
+        if not tls_information.hostname:
+            # Clean up any existing secrets if we're not rendering the HTTPS listener.
             resource_manager = TLSSecretResourceManager(
                 labels=self._labels,
                 client=client,
@@ -359,7 +364,7 @@ def _define_secret_resources(
             return
 
         resource_definition = SecretResourceDefinition.from_tls_information(
-            tls_information, config.external_hostname
+            tls_information, tls_information.hostname
         )
         resource_manager = TLSSecretResourceManager(
             labels=self._labels,
@@ -368,26 +373,30 @@ def _define_secret_resources(
         secret = resource_manager.define_resource(resource_definition)
         resource_manager.cleanup_resources(exclude=[secret])
 
-    def get_hostname(self) -> str:
+    def get_hostname(self) -> str | None:
         """Get the hostname from the charm's config or stored attribute.
 
         Returns:
             The hostname to be used for the gateway.
         """
         try:
-            if not self.model.get_relation(GATEWAY_ROUTE_RELATION):
-                return typing.cast(str, self.model.config.get("external-hostname"))
             client = get_client(field_manager=self.app.name, namespace=self.model.name)
-            config = CharmConfig.from_charm(self, client)
-            http_route_resource_information = HTTPRouteResourceInformation.from_provider(
-                config.external_hostname, self._ingress_provider, self._gateway_route_provider
+
+            config = CharmConfig.from_charm_and_providers(
+                self, client, self._ingress_provider, self._gateway_route_provider
+            )
+            tls_information = TLSInformation.from_charm(
+                self, config, self.certificates, self._gateway_route_provider
             )
-            return http_route_resource_information.hostname
+            return tls_information.hostname
         except (
             DataValidationError,
             IngressIntegrationMissingError,
             IngressIntegrationDataValidationError,
             IngressGatewayRouteConflictError,
+            GatewayRouteHostnameMissingError,
+            GatewayRouteRelationDataValidationError,
+            GatewayRouteRelationNotReadyError,
         ):
             return typing.cast(str, self.model.config.get("external-hostname"))
 
@@ -395,60 +404,128 @@ def _define_ingress_resources_and_publish_url(  # pylint: disable=too-many-local
         self,
         client: Client,
         config: CharmConfig,
+        tls_information: TLSInformation,
         gateway_resource_information: GatewayResourceInformation,
+        gateway_resource_manager: GatewayResourceManager,
     ) -> None:
         """Define ingress-relation resources and publish the ingress URL.
 
         Args:
             client: Lightkube client.
             config: Charm config.
+            tls_information: TLS information state component.
             gateway_resource_information: Information needed to attach http_route resources.
+            gateway_resource_manager: Gateway resource manager.
         """
-        http_route_resource_information = HTTPRouteResourceInformation.from_provider(
-            config.external_hostname, self._ingress_provider, self._gateway_route_provider
-        )
-        service_resource_manager = ServiceResourceManager(self._labels, client)
-        service = service_resource_manager.define_resource(
-            ServiceResourceDefinition(http_route_resource_information)
-        )
-        http_route_resource_manager = HTTPRouteResourceManager(self._labels, client)
+        http_route_resource_information = None
+        if config.proxy_mode == ProxyMode.INGRESS:
+            http_route_resource_information = HTTPRouteResourceInformation._from_ingress(
+                self._ingress_provider
+            )
 
+        if config.proxy_mode == ProxyMode.GATEWAY_ROUTE:
+            http_route_resource_information = HTTPRouteResourceInformation._from_gateway_route(
+                self._gateway_route_provider, tls_information
+            )
+
+        if http_route_resource_information is None:
+            logger.error("Can't determine HTTP route resource information from providers.")
+            return
+
+        http_route_resource_manager = HTTPRouteResourceManager(self._labels, client)
+        # If HTTPS is enforced, create 2 HTTPRoute resources for "HTTP" (redirect) and "HTTPS".
+        # If HTTPS is not enforced but a hostname is defined, create both "HTTP" and "HTTPS" HTTPRoute resources.
+        # If HTTPS is not enforced and no hostname is defined, only create the "HTTP" HTTPRoute resource.
+        http_route_resources = []
         if config.enforce_https:
             # When HTTPS is enforced, create both redirect and HTTPS routes
-            redirect_resource_manager = HTTPRouteRedirectResourceManager(self._labels, client)
-            redirect_route = redirect_resource_manager.define_resource(
+            http_route_resources = [
                 HTTPRouteResourceDefinition(
                     http_route_resource_information,
                     gateway_resource_information,
                     HTTPRouteType.HTTP,
-                )
-            )
-            https_route = http_route_resource_manager.define_resource(
+                    redirect_https=True,
+                ),
                 HTTPRouteResourceDefinition(
                     http_route_resource_information,
                     gateway_resource_information,
                     HTTPRouteType.HTTPS,
-                )
-            )
-            http_route_resource_manager.cleanup_resources(exclude=[https_route, redirect_route])
+                ),
+            ]
         else:
-            # When HTTPS is not enforced, create only HTTP route
-            http_route = http_route_resource_manager.define_resource(
+            http_route_resources = [
                 HTTPRouteResourceDefinition(
                     http_route_resource_information,
                     gateway_resource_information,
                     HTTPRouteType.HTTP,
+                    redirect_https=False,
+                ),
+            ]
+            if tls_information.hostname is not None:
+                http_route_resources.append(
+                    HTTPRouteResourceDefinition(
+                        http_route_resource_information,
+                        gateway_resource_information,
+                        HTTPRouteType.HTTPS,
+                    )
                 )
-            )
-            http_route_resource_manager.cleanup_resources(exclude=[http_route])
+        managed_http_route_resources = [
+            http_route_resource_manager.define_resource(http_route_resource)
+            for http_route_resource in http_route_resources
+        ]
+        http_route_resource_manager.cleanup_resources(exclude=managed_http_route_resources)
 
+        # Define service resource.
+        service_resource_manager = ServiceResourceManager(self._labels, client)
+        service = service_resource_manager.define_resource(
+            ServiceResourceDefinition(http_route_resource_information)
+        )
         service_resource_manager.cleanup_resources(exclude=[service])
+        self.publish_url(
+            gateway_resource_manager,
+            config,
+            tls_information,
+            gateway_resource_information,
+            http_route_resource_information,
+        )
+
+    def publish_url(
+        self,
+        gateway_resource_manager: GatewayResourceManager,
+        config: CharmConfig,
+        tls_information: TLSInformation,
+        gateway_resource_information: GatewayResourceInformation,
+        http_route_resource_information: HTTPRouteResourceInformation,
+    ) -> None:
+        """Publish the ingress URL to the requirer charm.
+
+        Args:
+            gateway_resource_manager: The Gateway resource manager to get the gateway address.
+            config: Charm config.
+            tls_information: TLS information state component.
+            gateway_resource_information: Information needed to attach http_route resources.
+            http_route_resource_information: Information needed to create HTTPRoute resources.
+        """
+        ingress_base_url = None
+        if config.enforce_https:
+            if hostname := tls_information.hostname:
+                ingress_base_url = f"https://{hostname}"
+            else:
+                logger.warning("Cannot publish URL, hostname is not defined for HTTPS route.")
+                return
+        else:
+            gateway_address = gateway_resource_manager.gateway_address(
+                gateway_resource_information.gateway_name
+            )
+            if not gateway_address:
+                logger.warning("Cannot publish URL, gateway address not found.")
+                return
+            ingress_base_url = f"http://{gateway_address}"
+
         ingress_relation = self.model.get_relation(INGRESS_RELATION)
         if ingress_relation:
-            protocol = "https" if config.enforce_https else "http"
-            hostname = config.external_hostname if config.external_hostname else "localhost"
             ingress_url = (
-                f"{protocol}://{hostname}"
+                f"{ingress_base_url}"
                 f"/{http_route_resource_information.requirer_model_name}"
                 f"-{http_route_resource_information.application_name}"
             )
@@ -459,12 +536,9 @@ def _define_ingress_resources_and_publish_url(  # pylint: disable=too-many-local
             )
 
         if gateway_route_relation := self.model.get_relation(GATEWAY_ROUTE_RELATION):
-            protocol = "https" if config.enforce_https else "http"
-            hostname_value = self.get_hostname()
-            hostname = hostname_value if hostname_value else "localhost"
             endpoints = []
             for path in http_route_resource_information.paths:
-                endpoints.append(f"{protocol}://{hostname}/{path.lstrip('/')}")
+                endpoints.append(f"{ingress_base_url}/{path.lstrip('/')}")
 
             self._gateway_route_provider.publish_endpoints(
                 endpoints,
diff --git a/gateway-api-integrator/src/resource_manager/gateway.py b/gateway-api-integrator/src/resource_manager/gateway.py
index e8cefedb..9c8bc164 100644
--- a/gateway-api-integrator/src/resource_manager/gateway.py
+++ b/gateway-api-integrator/src/resource_manager/gateway.py
@@ -39,17 +39,16 @@ class GatewayResourceDefinition(ResourceDefinition):
 
     Attributes:
         gateway_name: The gateway resource's name
-        external_hostname: The configured gateway hostname.
+        hostname: The configured gateway hostname.
         gateway_class_name: The configured gateway class.
         secret_resource_name_prefix: Prefix of the secret resource name.
-        enforce_https: Whether to enforce HTTPS by creating the HTTPS listener.
+        require_https_listener: Whether the gateway resource should have an HTTPS listener.
     """
 
     gateway_name: str
-    external_hostname: str
+    hostname: str | None
     gateway_class_name: str
     secret_resource_name_prefix: str
-    enforce_https: bool
 
     def __init__(
         self,
@@ -104,8 +103,6 @@ def _gen_resource(self, resource_definition: ResourceDefinition) -> dict:
         """
         gateway_resource_definition = typing.cast(GatewayResourceDefinition, resource_definition)
         prefix = gateway_resource_definition.secret_resource_name_prefix
-        tls_secret_name = f"{prefix}-{gateway_resource_definition.external_hostname}"
-
         listeners = [
             {
                 "protocol": "HTTP",
@@ -115,23 +112,17 @@ def _gen_resource(self, resource_definition: ResourceDefinition) -> dict:
             }
         ]
 
-        # Only add hostname to HTTP listener if one is configured
-        if gateway_resource_definition.external_hostname:
-            listeners[0]["hostname"] = gateway_resource_definition.external_hostname
-
-        # Only add HTTPS listener if enforce_https is true
-        if gateway_resource_definition.enforce_https:
-            https_listener = {
-                "protocol": "HTTPS",
-                "port": 443,
-                "name": f"{gateway_resource_definition.gateway_name}-https-listener",
-                "allowedRoutes": {"namespaces": {"from": "All"}},
-                "tls": {"certificateRefs": [{"kind": "Secret", "name": tls_secret_name}]},
-            }
-            # Only add hostname to HTTPS listener if one is configured
-            if gateway_resource_definition.external_hostname:
-                https_listener["hostname"] = gateway_resource_definition.external_hostname
-            listeners.append(https_listener)
+        if hostname := gateway_resource_definition.hostname:
+            tls_secret_name = f"{prefix}-{hostname}"
+            listeners.append(
+                {
+                    "protocol": "HTTPS",
+                    "port": 443,
+                    "name": f"{gateway_resource_definition.gateway_name}-https-listener",
+                    "allowedRoutes": {"namespaces": {"from": "All"}},
+                    "tls": {"certificateRefs": [{"kind": "Secret", "name": tls_secret_name}]},
+                }
+            )
 
         gateway = self._gateway_generic_resource(
             apiVersion="gateway.networking.k8s.io/v1",
diff --git a/gateway-api-integrator/src/resource_manager/http_route.py b/gateway-api-integrator/src/resource_manager/http_route.py
index ad4dcc05..4ade5a48 100644
--- a/gateway-api-integrator/src/resource_manager/http_route.py
+++ b/gateway-api-integrator/src/resource_manager/http_route.py
@@ -65,6 +65,7 @@ class HTTPRouteResourceDefinition(ResourceDefinition):
     service_name: str
     service_port: int
     http_route_type: HTTPRouteType
+    redirect_https: bool
     paths: list[str]
     filters: list[dict]
 
@@ -73,6 +74,7 @@ def __init__(
         http_route_resource_information: HTTPRouteResourceInformation,
         gateway_resource_information: GatewayResourceInformation,
         http_route_type: HTTPRouteType,
+        redirect_https: bool = False,
     ):
         """Create the state object with state components.
 
@@ -80,9 +82,11 @@ def __init__(
             http_route_resource_information: HTTPRouteResourceInformation state component.
             gateway_resource_information: GatewayResourceInformation state component.
             http_route_type: Type of the HTTP route, can be http or https.
+            redirect_https: Whether to redirect HTTP traffic to HTTPS.
         """
         super().__init__(http_route_resource_information, gateway_resource_information)
         self.http_route_type = http_route_type
+        self.redirect_https = redirect_https
 
     @property
     def matches(self) -> list[dict[str, dict[str, str]]]:
@@ -104,6 +108,78 @@ def matches(self) -> list[dict[str, dict[str, str]]]:
             )
         return match_list
 
+    @property
+    def listener_id(self) -> str:
+        """Get the listener id for the HTTPRoute resource.
+
+        The listener id is used to reference the corresponding listener in the parent Gateway resource.
+
+        Returns:
+            The listener id.
+        """
+        return f"{self.gateway_name}-{self.http_route_type}-listener"
+
+    @property
+    def http_route_resource_name(self) -> str:
+        """Get the HTTPRoute resource name.
+
+        Returns:
+            The HTTPRoute resource name.
+        """
+        return f"{self.gateway_name}-{self.http_route_type}"
+
+    def http_route_resource_spec(self, namespace: str) -> dict[str, typing.Any]:
+        """Generate a Gateway resource from a gateway resource definition.
+
+        Args:
+            namespace: The namespace where the gateway resource is located.
+
+        Returns:
+            A dictionary representing the gateway custom resource.
+        """
+        if self.redirect_https:
+            return {
+                "parentRefs": [
+                    {
+                        "name": self.gateway_name,
+                        "namespace": namespace,
+                        "sectionName": self.listener_id,
+                    }
+                ],
+                "rules": [
+                    {
+                        "filters": [
+                            {
+                                "type": "RequestRedirect",
+                                "requestRedirect": {"scheme": "https", "statusCode": 301},
+                            }
+                        ]
+                    }
+                ],
+            }
+
+        return {
+            "parentRefs": [
+                {
+                    "name": self.gateway_name,
+                    "namespace": namespace,
+                    "sectionName": self.listener_id,
+                }
+            ],
+            "rules": [
+                {
+                    "matches": self.matches,
+                    "filters": self.filters,
+                    "backendRefs": [
+                        {
+                            "name": self.service_name,
+                            "port": self.service_port,
+                        }
+                    ],
+                }
+            ],
+        }
+
 
 class HTTPRouteResourceManager(ResourceManager[GenericNamespacedResource]):
     """HTTP route resource manager."""
@@ -137,44 +213,14 @@ def _gen_resource(self, resource_definition: ResourceDefinition) -> GenericNames
             HTTPRouteResourceDefinition, resource_definition
         )
 
-        listener_id = (
-            f"{http_route_resource_definition.gateway_name}"
-            f"-{http_route_resource_definition.http_route_type}"
-            "-listener"
-        )
-        spec = {
-            "parentRefs": [
-                {
-                    "name": http_route_resource_definition.gateway_name,
-                    "namespace": self._client.namespace,
-                    "sectionName": listener_id,
-                }
-            ],
-            "rules": [
-                {
-                    "matches": http_route_resource_definition.matches,
-                    "filters": http_route_resource_definition.filters,
-                    "backendRefs": [
-                        {
-                            "name": http_route_resource_definition.service_name,
-                            "port": http_route_resource_definition.service_port,
-                        }
-                    ],
-                }
-            ],
-        }
-
         http_route = self._http_route_generic_resource_class(
             apiVersion=f"{CUSTOM_RESOURCE_GROUP_NAME}/v1",
             kind=HTTP_ROUTE_RESOURCE_NAME,
             metadata=ObjectMeta(
-                name=(
-                    f"{http_route_resource_definition.gateway_name}"
-                    f"-{http_route_resource_definition.http_route_type}"
-                ),
+                name=http_route_resource_definition.http_route_resource_name,
                 labels=self._labels,
             ),
-            spec=spec,
+            spec=http_route_resource_definition.http_route_resource_spec(self._client.namespace),
         )
 
         return http_route
@@ -226,62 +272,3 @@ def _delete_resource(self, name: str) -> None:
             name: The name of the secret resource to delete.
         """
         self._client.delete(res=self._http_route_generic_resource_class, name=name)
-
-
-class HTTPRouteRedirectResourceManager(HTTPRouteResourceManager):
-    """HTTP route resource manager that handles rediection."""
-
-    @map_k8s_auth_exception
-    def _gen_resource(self, resource_definition: ResourceDefinition) -> GenericNamespacedResource:
-        """Generate a Gateway resource from a gateway resource definition.
-
-        Args:
-            resource_definition: Part of charm state consisting of 2 components:
-                - HTTPRouteResourceInformation
-                - GatewayResourceDefinition
-
-        Returns:
-            A dictionary representing the gateway custom resource.
-        """
-        http_route_resource_definition = typing.cast(
-            HTTPRouteResourceDefinition, resource_definition
-        )
-
-        listener_id = (
-            f"{http_route_resource_definition.gateway_name}"
-            f"-{http_route_resource_definition.http_route_type}"
-            "-listener"
-        )
-        spec = {
-            "parentRefs": [
-                {
-                    "name": http_route_resource_definition.gateway_name,
-                    "namespace": self._client.namespace,
-                    "sectionName": listener_id,
-                }
-            ],
-            "rules": [
-                {
-                    "filters": [
-                        {
-                            "type": "RequestRedirect",
-                            "requestRedirect": {"scheme": "https", "statusCode": 301},
-                        }
-                    ]
-                }
-            ],
-        }
-        http_route = self._http_route_generic_resource_class(
-            apiVersion=f"{CUSTOM_RESOURCE_GROUP_NAME}/v1",
-            kind=HTTP_ROUTE_RESOURCE_NAME,
-            metadata=ObjectMeta(
-                name=(
-                    f"{http_route_resource_definition.gateway_name}"
-                    f"-{http_route_resource_definition.http_route_type}"
-                ),
-                labels=self._labels,
-            ),
-            spec=spec,
-        )
-
-        return http_route
diff --git a/gateway-api-integrator/src/state/base.py b/gateway-api-integrator/src/state/base.py
index 87f2862d..9acb8a2a 100644
--- a/gateway-api-integrator/src/state/base.py
+++ b/gateway-api-integrator/src/state/base.py
@@ -6,22 +6,24 @@
 import dataclasses
 import typing
 
+from src.state.http_route import HTTPRouteResourceInformation
+
 from .config import CharmConfig
 from .gateway import GatewayResourceInformation
 from .tls import TLSInformation
 
-Components = typing.TypeVar(
-    "Components",
+Component = typing.Union[
     GatewayResourceInformation,
     CharmConfig,
     TLSInformation,
-)
+    HTTPRouteResourceInformation,
+]
 
 
 class ResourceDefinition:  # pylint: disable=too-few-public-methods
-    """Fragment of charmstate that consists of one or several state components."""
+    """Fragment of charm state that consists of one or several state components."""
 
-    def __init__(self, *components: Components):
+    def __init__(self, *components: Component):
         """Create the state object with state components.
 
         Args:
diff --git a/gateway-api-integrator/src/state/config.py b/gateway-api-integrator/src/state/config.py
index d219fdbe..01eca93c 100644
--- a/gateway-api-integrator/src/state/config.py
+++ b/gateway-api-integrator/src/state/config.py
@@ -6,9 +6,11 @@
 import itertools
 import logging
 import typing
+from enum import StrEnum
 
 import ops
-from charms.gateway_api_integrator.v0.gateway_route import valid_fqdn
+from charms.gateway_api_integrator.v0.gateway_route import GatewayRouteProvider, valid_fqdn
+from charms.traefik_k8s.v2.ingress import IngressPerAppProvider
 from lightkube import Client
 from lightkube.generic_resource import create_global_resource
 from pydantic import BeforeValidator, Field, ValidationError
@@ -33,6 +35,23 @@ class GatewayClassUnavailableError(CharmStateValidationBaseError):
     """Exception raised when a charm configuration is found to be invalid."""
 
 
+class IngressGatewayRouteConflictError(CharmStateValidationBaseError):
+    """Exception raised when both ingress and gateway-route integrations are established."""
+
+
+class ProxyMode(StrEnum):
+    """StrEnum of possible modes of the gateway-api-integrator charm.
+
+    Attrs:
+        GATEWAY_ROUTE: When gateway-route is related.
+        INGRESS: when ingress is related.
+    """
+
+    GATEWAY_ROUTE = "gateway-route"
+    INGRESS = "ingress"
+    DEFAULT = "default"
+
+
 @dataclass(frozen=True)
 class CharmConfig:
     """A component of charm state that contains the charm's configuration.
@@ -46,23 +65,34 @@ class CharmConfig:
     external_hostname: typing.Annotated[str, BeforeValidator(valid_fqdn)] | None
     gateway_class_name: str = Field(min_length=1)
     enforce_https: bool = Field()
+    proxy_mode: ProxyMode = Field()
 
     @classmethod
     @map_k8s_auth_exception
-    def from_charm(cls, charm: ops.CharmBase, client: Client) -> "CharmConfig":
+    def from_charm_and_providers(
+        cls,
+        charm: ops.CharmBase,
+        client: Client,
+        ingress_provider: IngressPerAppProvider,
+        gateway_route_provider: GatewayRouteProvider,
+    ) -> "CharmConfig":
         """Create a CharmConfig class from a charm instance.
 
         Args:
             charm: The gateway-api-integrator charm.
             client: The lightkube client
+            ingress_provider: The ingress per app provider instance.
+            gateway_route_provider: The gateway route provider instance.
 
         Raises:
             InvalidCharmConfigError: When the charm's config is invalid.
             GatewayClassUnavailableError: When the cluster has no available gateway classes.
+            IngressGatewayRouteConflictError: When both ingress and gateway-route is present.
 
         Returns:
             CharmConfig: Instance of the charm config state component.
         """
+        proxy_mode = cls._validate_state(ingress_provider, gateway_route_provider)
         gateway_class_name = typing.cast(str, charm.config.get("gateway-class"))
         gateway_class_generic_resource = create_global_resource(
             CUSTOM_RESOURCE_GROUP_NAME, "v1", GATEWAY_CLASS_RESOURCE_NAME, GATEWAY_CLASS_PLURAL
@@ -91,22 +121,41 @@ def from_charm(cls, charm: ops.CharmBase, client: Client) -> "CharmConfig":
         enforce_https = typing.cast(bool, charm.config.get("enforce-https", True))
         external_hostname = typing.cast(str | None, charm.config.get("external-hostname"))
 
-        # Validate that hostname is provided when HTTPS is enforced
-        if enforce_https and not external_hostname:
-            raise InvalidCharmConfigError(
-                "external-hostname is required when enforce-https is true"
-            )
-
         try:
             return cls(
                 gateway_class_name=gateway_class_name,
                 external_hostname=external_hostname,
                 enforce_https=enforce_https,
+                proxy_mode=proxy_mode,
             )
         except ValidationError as exc:
             error_field_str = ",".join(f"{field}" for field in get_invalid_config_fields(exc))
             raise InvalidCharmConfigError(f"invalid configuration: {error_field_str}") from exc
 
+    @staticmethod
+    def _validate_state(
+        ingress_provider: IngressPerAppProvider,
+        gateway_route_provider: GatewayRouteProvider,
+    ) -> ProxyMode:
+        """Validate the charm config state.
+
+        Raises:
+            InvalidCharmConfigError: When the charm config is invalid.
+        """
+        is_ingress_related = bool(ingress_provider.relations)
+        is_gateway_route_related = gateway_route_provider.relation is not None
+        ingress_relations = ingress_provider.relations
+        gateway_route_relation = gateway_route_provider.relation
+        if ingress_relations and gateway_route_relation is not None:
+            raise IngressGatewayRouteConflictError(
+                "Both Ingress and Gateway Route integrations are established. Only one is allowed."
+            )
+        if is_ingress_related:
+            return ProxyMode.INGRESS
+        if is_gateway_route_related:
+            return ProxyMode.GATEWAY_ROUTE
+        return ProxyMode.DEFAULT
+
 
 def get_invalid_config_fields(exc: ValidationError) -> typing.Set[int | str]:
     """Return a list on invalid config from pydantic validation error.
diff --git a/gateway-api-integrator/src/state/gateway.py b/gateway-api-integrator/src/state/gateway.py
index 434733c1..4b1eeeb5 100644
--- a/gateway-api-integrator/src/state/gateway.py
+++ b/gateway-api-integrator/src/state/gateway.py
@@ -16,7 +16,6 @@ class GatewayResourceInformation:
         gateway_name: The gateway resource's name
     """
 
-    # We're expecting more fields to be added.
     gateway_name: str
 
     @classmethod
diff --git a/gateway-api-integrator/src/state/http_route.py b/gateway-api-integrator/src/state/http_route.py
index 15ec8de4..019f9826 100644
--- a/gateway-api-integrator/src/state/http_route.py
+++ b/gateway-api-integrator/src/state/http_route.py
@@ -5,10 +5,11 @@
 
 import dataclasses
 
-import ops
 from charms.gateway_api_integrator.v0.gateway_route import GatewayRouteProvider
 from charms.traefik_k8s.v2.ingress import DataValidationError, IngressPerAppProvider
 
+from src.state.tls import TLSInformation
+
 from .exception import CharmStateValidationBaseError
 
 INGRESS_RELATION = "gateway"
@@ -16,15 +17,19 @@
 
 
 class IngressIntegrationMissingError(CharmStateValidationBaseError):
-    """Exception raised when ingress integration is not established."""
+    """Exception raised when ingress relation is not established."""
 
 
 class IngressIntegrationDataValidationError(CharmStateValidationBaseError):
-    """Exception raised when ingress integration is not established."""
+    """Exception raised when ingress relation data validation fails."""
+
+
+class GatewayRouteRelationNotReadyError(CharmStateValidationBaseError):
+    """Exception raised when gateway route relation data is not ready."""
 
 
-class IngressGatewayRouteConflictError(CharmStateValidationBaseError):
-    """Exception raised when both ingress and gateway-route integrations are established."""
+class GatewayRouteRelationDataValidationError(CharmStateValidationBaseError):
+    """Exception raised when gateway route relation data validation fails."""
 
 
 class GatewayRouteHostnameMissingError(CharmStateValidationBaseError):
@@ -58,53 +63,6 @@ class HTTPRouteResourceInformation:
     paths: list[str]
     hostname: str
 
-    @classmethod
-    def from_provider(
-        cls,
-        external_hostname: str | None,
-        ingress_provider: IngressPerAppProvider,
-        gateway_route_provider: GatewayRouteProvider,
-    ) -> "HTTPRouteResourceInformation":
-        """Get TLS information from a charm instance.
-
-        Args:
-            external_hostname: The external-hostname charm configuration.
-            ingress_provider: The ingress provider library.
-            gateway_route_provider: The gateway route provider library.
-
-        Raises:
-            IngressIntegrationMissingError: When integration is not ready.
-            IngressIntegrationDataValidationError: When data validation failed.
-            IngressGatewayRouteConflictError: When both integrations are established.
-
-        Returns:
-            HTTPRouteResourceInformation: Information about configured TLS certs.
-        """
-        ingress_relations = ingress_provider.relations
-        gateway_route_relation = gateway_route_provider.relation
-        if ingress_relations and gateway_route_relation is not None:
-            raise IngressGatewayRouteConflictError(
-                "Both Ingress and Gateway Route integrations are established. Only one is allowed."
-            )
-        try:
-            if ingress_relations:
-                if len(ingress_relations) > 1:
-                    raise IngressIntegrationDataValidationError(
-                        "The charm does not support multiple ingress relations."
-                    )
-                return cls._from_ingress(ingress_provider)
-            if gateway_route_relation is not None:
-                return cls._from_gateway_route(
-                    external_hostname, gateway_route_provider, gateway_route_relation
-                )
-        except DataValidationError as exc:
-            raise IngressIntegrationDataValidationError(
-                "Validation of ingress relation data failed."
-            ) from exc
-        raise IngressIntegrationMissingError(
-            "Ingress and Gateway Route integration not ready. You must relate to either."
-        )
-
     @classmethod
     def _from_ingress(
         cls,
@@ -122,63 +80,74 @@ def _from_ingress(
         application_name = integration_data.app.name
         service_port = integration_data.app.port
         service_name = f"{ingress_provider.charm.app.name}-{application_name}-service"
-        return cls(
-            application_name=application_name,
-            requirer_model_name=integration_data.app.model,
-            service_name=service_name,
-            service_port=service_port,
-            service_port_name=f"tcp-{service_port}",
-            filters=(
-                []
-                if not integration_data.app.strip_prefix
-                else [
-                    {
-                        "type": "URLRewrite",
-                        "urlRewrite": {
-                            "path": {
-                                "type": "ReplacePrefixMatch",
-                                "replacePrefixMatch": "/",
-                            }
-                        },
-                    }
-                ]
-            ),
-            paths=[f"/{integration_data.app.model}-{application_name}"],
-            hostname="",
-        )
+        try:
+            return cls(
+                application_name=application_name,
+                requirer_model_name=integration_data.app.model,
+                service_name=service_name,
+                service_port=service_port,
+                service_port_name=f"tcp-{service_port}",
+                filters=(
+                    []
+                    if not integration_data.app.strip_prefix
+                    else [
+                        {
+                            "type": "URLRewrite",
+                            "urlRewrite": {
+                                "path": {
+                                    "type": "ReplacePrefixMatch",
+                                    "replacePrefixMatch": "/",
+                                }
+                            },
+                        }
+                    ]
+                ),
+                paths=[f"/{integration_data.app.model}-{application_name}"],
+                hostname="",
+            )
+        except DataValidationError as exc:
+            raise IngressIntegrationDataValidationError(
+                "Validation of ingress relation data failed."
+            ) from exc
 
     @classmethod
     def _from_gateway_route(
         cls,
-        external_hostname: str | None,
         gateway_route_provider: GatewayRouteProvider,
-        gateway_route_integration: ops.Relation,
+        tls_information: TLSInformation,
     ) -> "HTTPRouteResourceInformation":
         """Populate fields from ingress integration.
 
         Args:
-            external_hostname: The external-hostname charm configuration.
             gateway_route_provider: The gateway route provider library.
-            gateway_route_integration: The gateway-route integration.
+            tls_information: TLS-related information.
+
+        Raises:
+            GatewayRouteRelationDataValidationError: When data validation failed.
+            GatewayRouteHostnameMissingError: When hostname is not configured.
         """
-        integration_data = gateway_route_provider.get_data(gateway_route_integration)
-        if integration_data is None:
-            raise IngressIntegrationMissingError("Gateway Route integration data not ready.")
-        application_name = integration_data.application_data.name
-        service_port = integration_data.application_data.port
-        hostname = integration_data.application_data.hostname or external_hostname
-        if hostname is None:
-            raise IngressIntegrationDataValidationError(
+        if tls_information.hostname is None:
+            raise GatewayRouteHostnameMissingError(
                 "No hostname configured. Configure hostname either via"
                 " the gateway-route relation or by setting the external-hostname charm config."
             )
-        return cls(
-            application_name=application_name,
-            requirer_model_name=integration_data.application_data.model,
-            service_name=f"{gateway_route_provider.charm.app.name}-{application_name}-service",
-            service_port=service_port,
-            service_port_name=f"tcp-{service_port}",
-            filters=[],
-            paths=integration_data.application_data.paths,
-            hostname=hostname,
-        )
+        relation_data = gateway_route_provider.get_data()
+        if relation_data is None:
+            raise GatewayRouteRelationNotReadyError("gateway-route relation data not ready.")
+        application_name = relation_data.application_data.name
+        service_port = relation_data.application_data.port
+        try:
+            return cls(
+                application_name=application_name,
+                requirer_model_name=relation_data.application_data.model,
+                service_name=f"{gateway_route_provider.charm.app.name}-{application_name}-service",
+                service_port=service_port,
+                service_port_name=f"tcp-{service_port}",
+                filters=[],
+                paths=relation_data.application_data.paths,
+                hostname=tls_information.hostname,
+            )
+        except DataValidationError as exc:
+            raise GatewayRouteRelationDataValidationError(
+                "Validation of gateway-route relation data failed."
+            ) from exc
diff --git a/gateway-api-integrator/src/state/tls.py b/gateway-api-integrator/src/state/tls.py
index 1cb0435d..49eb4e8c 100644
--- a/gateway-api-integrator/src/state/tls.py
+++ b/gateway-api-integrator/src/state/tls.py
@@ -6,8 +6,11 @@
 import dataclasses
 
 import ops
+from charms.gateway_api_integrator.v0.gateway_route import GatewayRouteProvider
 from charms.tls_certificates_interface.v4.tls_certificates import TLSCertificatesRequiresV4
 
+from src.state.config import CharmConfig
+
 from .exception import CharmStateValidationBaseError
 
 TLS_CERTIFICATES_INTEGRATION = "certificates"
@@ -28,40 +31,54 @@ class TLSInformation:
     """
 
     secret_resource_name_prefix: str
+    hostname: str | None
     tls_certs: dict[str, str]
     tls_keys: dict[str, str]
 
     @classmethod
     def from_charm(
-        cls, charm: ops.CharmBase, certificates: TLSCertificatesRequiresV4, validate: bool = True
+        cls,
+        charm: ops.CharmBase,
+        config: CharmConfig,
+        certificates: TLSCertificatesRequiresV4,
+        gateway_route_provider: GatewayRouteProvider,
     ) -> "TLSInformation":
         """Get TLS information from a charm instance.
 
         Args:
             charm: The gateway-api-integrator charm.
+            config: The charm configuration.
             certificates: TLS certificates requirer library.
-            validate: Whether to validate that certificates relation is ready. Default is True.
+            gateway_route_provider: The gateway route provider.
 
         Returns:
             TLSInformation: Information about configured TLS certs.
         """
-        if validate:
-            cls.validate(charm)
-
         tls_certs = {}
         tls_keys = {}
         secret_resource_name_prefix = f"{charm.app.name}-secret"
 
-        for cert in certificates.get_provider_certificates():
-            hostname = cert.certificate.common_name
-            chain = cert.chain
-            if chain[0] != cert.certificate:
-                chain.reverse()
-            tls_certs[hostname] = "\n\n".join([str(cert) for cert in chain])
-            tls_keys[hostname] = str(certificates.private_key)
+        gateway_route_requirer_data = gateway_route_provider.get_data()
+        hostname = config.external_hostname
+        if (
+            gateway_route_requirer_data is not None
+            and gateway_route_requirer_data.application_data.hostname is not None
+        ):
+            hostname = gateway_route_requirer_data.application_data.hostname
+
+        if hostname is not None:
+            cls.validate(charm)
+            for cert in certificates.get_provider_certificates():
+                common_name = cert.certificate.common_name
+                chain = cert.chain
+                if chain[0] != cert.certificate:
+                    chain.reverse()
+                tls_certs[common_name] = "\n\n".join([str(cert) for cert in chain])
+                tls_keys[common_name] = str(certificates.private_key)
 
         return cls(
             secret_resource_name_prefix=secret_resource_name_prefix,
+            hostname=hostname,
             tls_certs=tls_certs,
             tls_keys=tls_keys,
         )
diff --git a/gateway-api-integrator/src/state/validation.py b/gateway-api-integrator/src/state/validation.py
index ff4ab974..0c58f086 100644
--- a/gateway-api-integrator/src/state/validation.py
+++ b/gateway-api-integrator/src/state/validation.py
@@ -12,8 +12,9 @@
 
 import client
 from resource_manager.resource_manager import InvalidResourceError
+from state.config import IngressGatewayRouteConflictError
 from state.exception import CharmStateValidationBaseError
-from state.http_route import IngressGatewayRouteConflictError, IngressIntegrationMissingError
+from state.http_route import IngressIntegrationMissingError
 
 logger = logging.getLogger(__name__)
 
diff --git a/gateway-api-integrator/tests/unit/test_config.py b/gateway-api-integrator/tests/unit/test_config.py
index 8b513d81..65b4c38b 100644
--- a/gateway-api-integrator/tests/unit/test_config.py
+++ b/gateway-api-integrator/tests/unit/test_config.py
@@ -40,7 +40,7 @@ def test_config(harness: Harness, available_gateway_classes: str):
     )
     harness.begin()
     with pytest.raises(InvalidCharmConfigError):
-        _ = CharmConfig.from_charm(harness.charm, client_mock)
+        _ = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
 
 
 def test_config_enforce_https_with_hostname(harness: Harness):
@@ -62,7 +62,7 @@ def test_config_enforce_https_with_hostname(harness: Harness):
     )
     harness.begin()
 
-    config = CharmConfig.from_charm(harness.charm, client_mock)
+    config = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
 
     assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
     assert config.external_hostname == "example.com"
@@ -88,7 +88,7 @@ def test_config_enforce_https_false_without_hostname(harness: Harness):
     )
     harness.begin()
 
-    config = CharmConfig.from_charm(harness.charm, client_mock)
+    config = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
 
     assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
     assert config.external_hostname == ""
@@ -115,7 +115,7 @@ def test_config_enforce_https_true_without_hostname(harness: Harness):
     harness.begin()
 
     with pytest.raises(InvalidCharmConfigError, match="external-hostname is required"):
-        _ = CharmConfig.from_charm(harness.charm, client_mock)
+        _ = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
 
 
 def test_config_enforce_https_false_with_hostname(harness: Harness):
@@ -137,7 +137,7 @@ def test_config_enforce_https_false_with_hostname(harness: Harness):
     )
     harness.begin()
 
-    config = CharmConfig.from_charm(harness.charm, client_mock)
+    config = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
 
     assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
     assert config.external_hostname == "example.com"
@@ -164,4 +164,4 @@ def test_config_invalid_hostname_format(harness: Harness):
     harness.begin()
 
     with pytest.raises(InvalidCharmConfigError, match="external-hostname must match pattern"):
-        _ = CharmConfig.from_charm(harness.charm, client_mock)
+        _ = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
diff --git a/gateway-api-integrator/tests/unit/test_gateway.py b/gateway-api-integrator/tests/unit/test_gateway.py
index 03883181..9cfbeecc 100644
--- a/gateway-api-integrator/tests/unit/test_gateway.py
+++ b/gateway-api-integrator/tests/unit/test_gateway.py
@@ -146,7 +146,7 @@ def test_gateway_gen_resource(
         client=client_with_mock_external,
     )
     tls_information = TLSInformation.from_charm(harness.charm, harness.charm.certificates)
-    config = CharmConfig.from_charm(harness.charm, client_with_mock_external)
+    config = CharmConfig.from_charm_and_providers(harness.charm, client_with_mock_external)
     gateway_resource = gateway_resource_manager._gen_resource(
         GatewayResourceDefinition(gateway_resource_information, config, tls_information)
     )
@@ -179,7 +179,7 @@ def test_gateway_gen_resource_enforce_https_true(
         client=client_with_mock_external,
     )
     tls_information = TLSInformation.from_charm(harness.charm, harness.charm.certificates)
-    charm_config = CharmConfig.from_charm(harness.charm, client_with_mock_external)
+    charm_config = CharmConfig.from_charm_and_providers(harness.charm, client_with_mock_external)
     gateway_resource = gateway_resource_manager._gen_resource(
         GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
     )
@@ -227,7 +227,7 @@ def test_gateway_gen_resource_enforce_https_false(
     tls_information = TLSInformation.from_charm(
         harness.charm, harness.charm.certificates, validate=False
     )
-    charm_config = CharmConfig.from_charm(harness.charm, client_with_mock_external)
+    charm_config = CharmConfig.from_charm_and_providers(harness.charm, client_with_mock_external)
     gateway_resource = gateway_resource_manager._gen_resource(
         GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
     )
@@ -275,7 +275,7 @@ def test_gateway_gen_resource_enforce_https_false_with_hostname(
     tls_information = TLSInformation.from_charm(
         harness.charm, harness.charm.certificates, validate=False
     )
-    charm_config = CharmConfig.from_charm(harness.charm, client_with_mock_external)
+    charm_config = CharmConfig.from_charm_and_providers(harness.charm, client_with_mock_external)
     gateway_resource = gateway_resource_manager._gen_resource(
         GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
     )
diff --git a/gateway-api-integrator/tests/unit/test_http_route.py b/gateway-api-integrator/tests/unit/test_http_route.py
index abad35c5..ffbb496b 100644
--- a/gateway-api-integrator/tests/unit/test_http_route.py
+++ b/gateway-api-integrator/tests/unit/test_http_route.py
@@ -13,7 +13,6 @@
 from ops.testing import Harness
 
 from resource_manager.http_route import (
-    HTTPRouteRedirectResourceManager,
     HTTPRouteResourceDefinition,
     HTTPRouteResourceManager,
     HTTPRouteType,
@@ -86,17 +85,6 @@ def test_httproute_gen_resource(
         labels=harness.charm._labels,
         client=client_mock,
     )
-    redirect_route_resource_manager = HTTPRouteRedirectResourceManager(
-        labels=harness.charm._labels,
-        client=client_mock,
-    )
-    redirect_route_resource = redirect_route_resource_manager._gen_resource(
-        HTTPRouteResourceDefinition(
-            http_route_resource_information,
-            gateway_resource_information,
-            HTTPRouteType.HTTP,
-        )
-    )
     https_route_resource = http_route_resource_manager._gen_resource(
         HTTPRouteResourceDefinition(
             http_route_resource_information,
@@ -104,10 +92,6 @@ def test_httproute_gen_resource(
             HTTPRouteType.HTTPS,
         )
     )
-    assert (
-        redirect_route_resource.spec["parentRefs"][0]["sectionName"]
-        == f"{harness.model.app.name}-http-listener"
-    )
     assert (
         https_route_resource.spec["parentRefs"][0]["sectionName"]
         == f"{harness.model.app.name}-https-listener"
diff --git a/gateway-api-integrator/tests/unit_scenario/conftest.py b/gateway-api-integrator/tests/unit_scenario/conftest.py
index c11337bc..866f5a29 100644
--- a/gateway-api-integrator/tests/unit_scenario/conftest.py
+++ b/gateway-api-integrator/tests/unit_scenario/conftest.py
@@ -8,7 +8,7 @@
 import pytest
 from ops import testing
 
-from src.state.config import CharmConfig  # pylint: disable=import-error
+from src.state.config import CharmConfig, ProxyMode
 
 TEST_EXTERNAL_HOSTNAME_CONFIG = "www.gateway.internal"
 GATEWAY_CLASS_CONFIG = "cilium"
@@ -20,12 +20,13 @@ def base_state_fixture(monkeypatch: pytest.MonkeyPatch):
     monkeypatch.setattr("client.KubeConfig", MagicMock())
     monkeypatch.setattr("client.Client", MagicMock())
     monkeypatch.setattr(
-        "charm.CharmConfig.from_charm",
+        "charm.CharmConfig.from_charm_and_providers",
         MagicMock(
             return_value=CharmConfig(
                 gateway_class_name=GATEWAY_CLASS_CONFIG,
                 external_hostname=TEST_EXTERNAL_HOSTNAME_CONFIG,
                 enforce_https=True,
+                proxy_mode=ProxyMode.DEFAULT,
             )
         ),
     )

From 4bb85ab96aa24ff7a4c021c3827d8a47442246fd Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 10:08:09 +0100
Subject: [PATCH 14/32] remove tests

---
 .../tests/unit/test_config.py                 | 124 ----------------
 .../tests/unit/test_gateway.py                | 140 ------------------
 2 files changed, 264 deletions(-)

diff --git a/gateway-api-integrator/tests/unit/test_config.py b/gateway-api-integrator/tests/unit/test_config.py
index 65b4c38b..9a7f0305 100644
--- a/gateway-api-integrator/tests/unit/test_config.py
+++ b/gateway-api-integrator/tests/unit/test_config.py
@@ -41,127 +41,3 @@ def test_config(harness: Harness, available_gateway_classes: str):
     harness.begin()
     with pytest.raises(InvalidCharmConfigError):
         _ = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
-
-
-def test_config_enforce_https_with_hostname(harness: Harness):
-    """
-    arrange: Given a charm with enforce-https enabled and a valid hostname.
-    act: Initialize the CharmConfig state component.
-    assert: CharmConfig is created successfully with enforce_https=True.
-    """
-    harness.update_config(
-        {
-            "gateway-class": GATEWAY_CLASS_CONFIG,
-            "external-hostname": "example.com",
-            "enforce-https": True,
-        }
-    )
-    client_mock = MagicMock(spec=Client)
-    client_mock.list = MagicMock(
-        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
-    )
-    harness.begin()
-
-    config = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
-
-    assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
-    assert config.external_hostname == "example.com"
-    assert config.enforce_https is True
-
-
-def test_config_enforce_https_false_without_hostname(harness: Harness):
-    """
-    arrange: Given a charm with enforce-https disabled and no hostname.
-    act: Initialize the CharmConfig state component.
-    assert: CharmConfig is created successfully with enforce_https=False and empty hostname.
-    """
-    harness.update_config(
-        {
-            "gateway-class": GATEWAY_CLASS_CONFIG,
-            "external-hostname": "",
-            "enforce-https": False,
-        }
-    )
-    client_mock = MagicMock(spec=Client)
-    client_mock.list = MagicMock(
-        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
-    )
-    harness.begin()
-
-    config = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
-
-    assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
-    assert config.external_hostname == ""
-    assert config.enforce_https is False
-
-
-def test_config_enforce_https_true_without_hostname(harness: Harness):
-    """
-    arrange: Given a charm with enforce-https enabled but no hostname.
-    act: Initialize the CharmConfig state component.
-    assert: InvalidCharmConfigError is raised.
-    """
-    harness.update_config(
-        {
-            "gateway-class": GATEWAY_CLASS_CONFIG,
-            "external-hostname": "",
-            "enforce-https": True,
-        }
-    )
-    client_mock = MagicMock(spec=Client)
-    client_mock.list = MagicMock(
-        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
-    )
-    harness.begin()
-
-    with pytest.raises(InvalidCharmConfigError, match="external-hostname is required"):
-        _ = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
-
-
-def test_config_enforce_https_false_with_hostname(harness: Harness):
-    """
-    arrange: Given a charm with enforce-https disabled and a valid hostname.
-    act: Initialize the CharmConfig state component.
-    assert: CharmConfig is created successfully with enforce_https=False and hostname set.
-    """
-    harness.update_config(
-        {
-            "gateway-class": GATEWAY_CLASS_CONFIG,
-            "external-hostname": "example.com",
-            "enforce-https": False,
-        }
-    )
-    client_mock = MagicMock(spec=Client)
-    client_mock.list = MagicMock(
-        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
-    )
-    harness.begin()
-
-    config = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
-
-    assert config.gateway_class_name == GATEWAY_CLASS_CONFIG
-    assert config.external_hostname == "example.com"
-    assert config.enforce_https is False
-
-
-def test_config_invalid_hostname_format(harness: Harness):
-    """
-    arrange: Given a charm with an invalid hostname format.
-    act: Initialize the CharmConfig state component.
-    assert: InvalidCharmConfigError is raised.
-    """
-    harness.update_config(
-        {
-            "gateway-class": GATEWAY_CLASS_CONFIG,
-            "external-hostname": "INVALID_HOSTNAME",
-            "enforce-https": False,
-        }
-    )
-    client_mock = MagicMock(spec=Client)
-    client_mock.list = MagicMock(
-        return_value=[GenericGlobalResource(metadata=ObjectMeta(name=GATEWAY_CLASS_CONFIG))]
-    )
-    harness.begin()
-
-    with pytest.raises(InvalidCharmConfigError, match="external-hostname must match pattern"):
-        _ = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
diff --git a/gateway-api-integrator/tests/unit/test_gateway.py b/gateway-api-integrator/tests/unit/test_gateway.py
index 9cfbeecc..3bf25917 100644
--- a/gateway-api-integrator/tests/unit/test_gateway.py
+++ b/gateway-api-integrator/tests/unit/test_gateway.py
@@ -155,146 +155,6 @@ def test_gateway_gen_resource(
     assert len(gateway_resource.spec["listeners"])
 
 
-def test_gateway_gen_resource_enforce_https_true(
-    harness: Harness,
-    config: dict[str, str],
-    certificates_relation_data: dict[str, str],
-    client_with_mock_external: MagicMock,
-):
-    """
-    arrange: Given a charm with enforce-https enabled and valid config.
-    act: Call _gen_resource from the required state components.
-    assert: The Gateway resource has both HTTP and HTTPS listeners.
-    """
-    config_with_enforce_https: dict[str, str | bool] = {**config, "enforce-https": True}
-
-    relation_id = harness.add_relation("certificates", "self-signed-certificates")
-    harness.update_relation_data(relation_id, harness.model.app.name, certificates_relation_data)
-    harness.update_config(config_with_enforce_https)  # type: ignore[arg-type]
-    harness.begin()
-
-    gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
-    gateway_resource_manager = GatewayResourceManager(
-        labels=harness.charm._labels,
-        client=client_with_mock_external,
-    )
-    tls_information = TLSInformation.from_charm(harness.charm, harness.charm.certificates)
-    charm_config = CharmConfig.from_charm_and_providers(harness.charm, client_with_mock_external)
-    gateway_resource = gateway_resource_manager._gen_resource(
-        GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
-    )
-
-    assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
-    listeners = gateway_resource.spec["listeners"]
-    assert len(listeners) == 2
-
-    # Check HTTP listener
-    http_listener = next(listener for listener in listeners if listener["protocol"] == "HTTP")
-    assert http_listener["port"] == 80
-    assert "hostname" in http_listener
-
-    # Check HTTPS listener
-    https_listener = next(listener for listener in listeners if listener["protocol"] == "HTTPS")
-    assert https_listener["port"] == 443
-    assert "tls" in https_listener
-    assert "hostname" in https_listener
-
-
-def test_gateway_gen_resource_enforce_https_false(
-    harness: Harness,
-    client_with_mock_external: MagicMock,
-):
-    """
-    arrange: Given a charm with enforce-https disabled.
-    act: Call _gen_resource from the required state components.
-    assert: The Gateway resource has only HTTP listener, no HTTPS listener.
-    """
-    config_no_https: dict[str, str | bool] = {
-        "gateway-class": GATEWAY_CLASS_CONFIG,
-        "external-hostname": "",
-        "enforce-https": False,
-    }
-
-    harness.update_config(config_no_https)  # type: ignore[arg-type]
-    harness.begin()
-
-    gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
-    gateway_resource_manager = GatewayResourceManager(
-        labels=harness.charm._labels,
-        client=client_with_mock_external,
-    )
-    # Don't validate TLS since enforce_https is False
-    tls_information = TLSInformation.from_charm(
-        harness.charm, harness.charm.certificates, validate=False
-    )
-    charm_config = CharmConfig.from_charm_and_providers(harness.charm, client_with_mock_external)
-    gateway_resource = gateway_resource_manager._gen_resource(
-        GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
-    )
-
-    assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
-    listeners = gateway_resource.spec["listeners"]
-    assert len(listeners) == 1
-
-    # Check only HTTP listener is present
-    http_listener = listeners[0]
-    assert http_listener["protocol"] == "HTTP"
-    assert http_listener["port"] == 80
-    # No hostname should be set when it's not provided
-    assert "hostname" not in http_listener
-
-    # Verify no HTTPS listener
-    https_listeners = [listener for listener in listeners if listener["protocol"] == "HTTPS"]
-    assert len(https_listeners) == 0
-
-
-def test_gateway_gen_resource_enforce_https_false_with_hostname(
-    harness: Harness,
-    client_with_mock_external: MagicMock,
-):
-    """
-    arrange: Given a charm with enforce-https disabled but with a hostname.
-    act: Call _gen_resource from the required state components.
-    assert: The Gateway resource has only HTTP listener with hostname set.
-    """
-    config_http_with_hostname: dict[str, str | bool] = {
-        "gateway-class": GATEWAY_CLASS_CONFIG,
-        "external-hostname": "example.com",
-        "enforce-https": False,
-    }
-
-    harness.update_config(config_http_with_hostname)  # type: ignore[arg-type]
-    harness.begin()
-
-    gateway_resource_information = GatewayResourceInformation.from_charm(harness.charm)
-    gateway_resource_manager = GatewayResourceManager(
-        labels=harness.charm._labels,
-        client=client_with_mock_external,
-    )
-    # Don't validate TLS since enforce_https is False
-    tls_information = TLSInformation.from_charm(
-        harness.charm, harness.charm.certificates, validate=False
-    )
-    charm_config = CharmConfig.from_charm_and_providers(harness.charm, client_with_mock_external)
-    gateway_resource = gateway_resource_manager._gen_resource(
-        GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
-    )
-
-    assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
-    listeners = gateway_resource.spec["listeners"]
-    assert len(listeners) == 1
-
-    # Check only HTTP listener is present with hostname
-    http_listener = listeners[0]
-    assert http_listener["protocol"] == "HTTP"
-    assert http_listener["port"] == 80
-    assert http_listener["hostname"] == "example.com"
-
-    # Verify no HTTPS listener
-    https_listeners = [listener for listener in listeners if listener["protocol"] == "HTTPS"]
-    assert len(https_listeners) == 0
-
-
 def test_get_current_gateway_no_resource(mock_lightkube_client: MagicMock):
     """
     arrange: Given an GatewayResourceManager with mocked lightkube client

From ac1d816b0cba809a245f9f015634f4c6494fff0e Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 13:01:15 +0100
Subject: [PATCH 15/32] update/fix unit tests

---
 gateway-api-integrator/src/charm.py           | 33 +++++++++----
 .../src/resource_manager/__init__.py          |  6 +++
 gateway-api-integrator/src/state/__init__.py  |  6 +++
 gateway-api-integrator/src/state/base.py      |  2 +-
 .../src/state/http_route.py                   | 11 ++---
 gateway-api-integrator/src/state/tls.py       |  2 +-
 .../unit/test_certificates_integration.py     |  8 ++-
 .../tests/unit/test_client.py                 | 29 ++++++++++-
 .../tests/unit/test_config.py                 |  7 ++-
 .../tests/unit/test_gateway.py                | 49 ++++---------------
 .../tests/unit/test_http_route.py             | 24 ++-------
 .../tests/unit/test_secret.py                 | 18 +++++--
 12 files changed, 112 insertions(+), 83 deletions(-)
 create mode 100644 gateway-api-integrator/src/resource_manager/__init__.py
 create mode 100644 gateway-api-integrator/src/state/__init__.py

diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index a20d2b22..09d2c190 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -46,9 +46,16 @@
     HTTPRouteResourceManager,
     HTTPRouteType,
 )
+from resource_manager.permission import InsufficientPermissionError
 from resource_manager.secret import SecretResourceDefinition, TLSSecretResourceManager
 from resource_manager.service import ServiceResourceDefinition, ServiceResourceManager
-from state.config import CharmConfig, IngressGatewayRouteConflictError, ProxyMode
+from state.config import (
+    CharmConfig,
+    GatewayClassUnavailableError,
+    IngressGatewayRouteConflictError,
+    InvalidCharmConfigError,
+    ProxyMode,
+)
 from state.gateway import GatewayResourceInformation
 from state.http_route import (
     GatewayRouteHostnameMissingError,
@@ -134,10 +141,9 @@ def _get_certificate_requests(self) -> list[CertificateRequestAttributes]:
         Returns:
             A list of CertificateRequestAttributes for the requested hostnames.
         """
-        hostnames = []
         if hostname := self.get_hostname():
-            hostnames = [hostname]
-        return [CertificateRequestAttributes(common_name=name) for name in hostnames]
+            return [CertificateRequestAttributes(common_name=hostname)]
+        return []
 
     @property
     def _labels(self) -> LabelSelector:
@@ -381,14 +387,18 @@ def get_hostname(self) -> str | None:
         """
         try:
             client = get_client(field_manager=self.app.name, namespace=self.model.name)
-
             config = CharmConfig.from_charm_and_providers(
                 self, client, self._ingress_provider, self._gateway_route_provider
             )
-            tls_information = TLSInformation.from_charm(
-                self, config, self.certificates, self._gateway_route_provider
-            )
-            return tls_information.hostname
+            gateway_route_requirer_data = self._gateway_route_provider.get_data()
+            hostname = config.external_hostname
+            if (
+                gateway_route_requirer_data is not None
+                and gateway_route_requirer_data.application_data.hostname is not None
+            ):
+                hostname = gateway_route_requirer_data.application_data.hostname
+
+            return hostname
         except (
             DataValidationError,
             IngressIntegrationMissingError,
@@ -397,8 +407,11 @@ def get_hostname(self) -> str | None:
             GatewayRouteHostnameMissingError,
             GatewayRouteRelationDataValidationError,
             GatewayRouteRelationNotReadyError,
+            GatewayClassUnavailableError,
+            InvalidCharmConfigError,
+            InsufficientPermissionError,
         ):
-            return typing.cast(str, self.model.config.get("external-hostname"))
+            return None
 
     def _define_ingress_resources_and_publish_url(  # pylint: disable=too-many-locals
         self,
diff --git a/gateway-api-integrator/src/resource_manager/__init__.py b/gateway-api-integrator/src/resource_manager/__init__.py
new file mode 100644
index 00000000..18cd3eca
--- /dev/null
+++ b/gateway-api-integrator/src/resource_manager/__init__.py
@@ -0,0 +1,6 @@
+#!/usr/bin/env python3
+
+# Copyright 2025 Canonical Ltd.
+# See LICENSE file for licensing details.
+
+"""Resource management package for gateway-api-integrator operator."""
\ No newline at end of file
diff --git a/gateway-api-integrator/src/state/__init__.py b/gateway-api-integrator/src/state/__init__.py
new file mode 100644
index 00000000..359aab7c
--- /dev/null
+++ b/gateway-api-integrator/src/state/__init__.py
@@ -0,0 +1,6 @@
+#!/usr/bin/env python3
+
+# Copyright 2025 Canonical Ltd.
+# See LICENSE file for licensing details.
+
+"""State management package for gateway-api-integrator operator."""
diff --git a/gateway-api-integrator/src/state/base.py b/gateway-api-integrator/src/state/base.py
index 9acb8a2a..ed964091 100644
--- a/gateway-api-integrator/src/state/base.py
+++ b/gateway-api-integrator/src/state/base.py
@@ -6,7 +6,7 @@
 import dataclasses
 import typing
 
-from src.state.http_route import HTTPRouteResourceInformation
+from state.http_route import HTTPRouteResourceInformation
 
 from .config import CharmConfig
 from .gateway import GatewayResourceInformation
diff --git a/gateway-api-integrator/src/state/http_route.py b/gateway-api-integrator/src/state/http_route.py
index 019f9826..49fd70a4 100644
--- a/gateway-api-integrator/src/state/http_route.py
+++ b/gateway-api-integrator/src/state/http_route.py
@@ -8,7 +8,7 @@
 from charms.gateway_api_integrator.v0.gateway_route import GatewayRouteProvider
 from charms.traefik_k8s.v2.ingress import DataValidationError, IngressPerAppProvider
 
-from src.state.tls import TLSInformation
+from state.tls import TLSInformation
 
 from .exception import CharmStateValidationBaseError
 
@@ -75,12 +75,11 @@ def _from_ingress(
             ingress_provider (IngressPerAppProvider): The ingress provider class.
             ingress_integration (ops.Relation): The ingress integration.
         """
-        # Validation that len(ingress_provider.relations) == 1 is done in the caller method
-        integration_data = ingress_provider.get_data(ingress_provider.relations[0])
-        application_name = integration_data.app.name
-        service_port = integration_data.app.port
-        service_name = f"{ingress_provider.charm.app.name}-{application_name}-service"
         try:
+            integration_data = ingress_provider.get_data(ingress_provider.relations[0])
+            application_name = integration_data.app.name
+            service_port = integration_data.app.port
+            service_name = f"{ingress_provider.charm.app.name}-{application_name}-service"
             return cls(
                 application_name=application_name,
                 requirer_model_name=integration_data.app.model,
diff --git a/gateway-api-integrator/src/state/tls.py b/gateway-api-integrator/src/state/tls.py
index 49eb4e8c..3bbda0d0 100644
--- a/gateway-api-integrator/src/state/tls.py
+++ b/gateway-api-integrator/src/state/tls.py
@@ -9,7 +9,7 @@
 from charms.gateway_api_integrator.v0.gateway_route import GatewayRouteProvider
 from charms.tls_certificates_interface.v4.tls_certificates import TLSCertificatesRequiresV4
 
-from src.state.config import CharmConfig
+from state.config import CharmConfig
 
 from .exception import CharmStateValidationBaseError
 
diff --git a/gateway-api-integrator/tests/unit/test_certificates_integration.py b/gateway-api-integrator/tests/unit/test_certificates_integration.py
index 7873d8a1..237d964d 100644
--- a/gateway-api-integrator/tests/unit/test_certificates_integration.py
+++ b/gateway-api-integrator/tests/unit/test_certificates_integration.py
@@ -6,6 +6,7 @@
 import pytest
 from ops.testing import Harness
 
+from state.config import CharmConfig, ProxyMode
 from state.tls import TLSInformation, TlsIntegrationMissingError
 
 
@@ -18,4 +19,9 @@ def test_tls_information_integration_missing(harness: Harness):
     """
     harness.begin()
     with pytest.raises(TlsIntegrationMissingError):
-        TLSInformation.from_charm(harness.charm, harness.charm.certificates)
+        TLSInformation.from_charm(
+            harness.charm,
+            CharmConfig("example.com", "cilium", True, ProxyMode.DEFAULT),
+            harness.charm.certificates,
+            harness.charm._gateway_route_provider,
+        )
diff --git a/gateway-api-integrator/tests/unit/test_client.py b/gateway-api-integrator/tests/unit/test_client.py
index 6b61e0b3..1ad39619 100644
--- a/gateway-api-integrator/tests/unit/test_client.py
+++ b/gateway-api-integrator/tests/unit/test_client.py
@@ -8,7 +8,11 @@
 from unittest.mock import MagicMock
 
 import pytest
-from lightkube.core.exceptions import ConfigError
+from httpx import Response
+from lightkube.core.client import Client
+from lightkube.core.exceptions import ApiError, ConfigError
+from lightkube.models.meta_v1 import Status
+from ops.testing import Harness
 
 from client import LightKubeInitializationError, cleanup_all_resources, get_client
 
@@ -69,3 +73,26 @@ class MockLightKubeResource:
     )
     cleanup_all_resources(client_mock, {})
     delete_mock.assert_not_called()
+
+
+def test_client_api_error_4xx(
+    harness: Harness,
+    monkeypatch: pytest.MonkeyPatch,
+):
+    """
+    arrange: given a charm with mocked lightkube client that returns 404.
+    act: when agent reconciliation triggers.
+    assert: Exception is re-raised.
+    """
+    monkeypatch.setattr(
+        "lightkube.models.meta_v1.Status.from_dict", MagicMock(return_value=Status(code=404))
+    )
+    lightkube_client_mock = MagicMock(spec=Client)
+    lightkube_client_mock.list = MagicMock(side_effect=ApiError(response=MagicMock(spec=Response)))
+    monkeypatch.setattr(
+        "charm.get_client",
+        MagicMock(return_value=lightkube_client_mock),
+    )
+
+    with pytest.raises(ApiError):
+        harness.begin()
diff --git a/gateway-api-integrator/tests/unit/test_config.py b/gateway-api-integrator/tests/unit/test_config.py
index 9a7f0305..1536c2a8 100644
--- a/gateway-api-integrator/tests/unit/test_config.py
+++ b/gateway-api-integrator/tests/unit/test_config.py
@@ -40,4 +40,9 @@ def test_config(harness: Harness, available_gateway_classes: str):
     )
     harness.begin()
     with pytest.raises(InvalidCharmConfigError):
-        _ = CharmConfig.from_charm_and_providers(harness.charm, client_mock)
+        _ = CharmConfig.from_charm_and_providers(
+            harness.charm,
+            client_mock,
+            harness.charm._ingress_provider,
+            harness.charm._gateway_route_provider,
+        )
diff --git a/gateway-api-integrator/tests/unit/test_gateway.py b/gateway-api-integrator/tests/unit/test_gateway.py
index 3bf25917..0f143c2c 100644
--- a/gateway-api-integrator/tests/unit/test_gateway.py
+++ b/gateway-api-integrator/tests/unit/test_gateway.py
@@ -88,42 +88,6 @@ def test_gateway_resource_definition_insufficient_permission(
     assert harness.charm.unit.status.name == ops.BlockedStatus.name
 
 
-def test_gateway_resource_definition_api_error_4xx(
-    harness: Harness,
-    certificates_relation_data: dict[str, str],
-    gateway_relation: dict[str, dict[str, str]],
-    monkeypatch: pytest.MonkeyPatch,
-    config: dict[str, str],
-):
-    """
-    arrange: given a charm with mocked lightkube client that returns 404.
-    act: when agent reconciliation triggers.
-    assert: Exception is re-raised.
-    """
-    harness.add_relation(
-        "certificates", "self-signed-certificates", app_data=certificates_relation_data
-    )
-    harness.add_relation(
-        "gateway",
-        "requirer-charm",
-        app_data=gateway_relation["app_data"],
-        unit_data=gateway_relation["unit_data"],
-    )
-    monkeypatch.setattr(
-        "lightkube.models.meta_v1.Status.from_dict", MagicMock(return_value=Status(code=404))
-    )
-    lightkube_client_mock = MagicMock(spec=Client)
-    lightkube_client_mock.list = MagicMock(side_effect=ApiError(response=MagicMock(spec=Response)))
-    monkeypatch.setattr(
-        "charm.get_client",
-        MagicMock(return_value=lightkube_client_mock),
-    )
-    harness.begin()
-
-    with pytest.raises(ApiError):
-        harness.update_config(config)
-
-
 def test_gateway_gen_resource(
     harness: Harness,
     config: dict[str, str],
@@ -145,10 +109,17 @@ def test_gateway_gen_resource(
         labels=harness.charm._labels,
         client=client_with_mock_external,
     )
-    tls_information = TLSInformation.from_charm(harness.charm, harness.charm.certificates)
-    config = CharmConfig.from_charm_and_providers(harness.charm, client_with_mock_external)
+    charm_config = CharmConfig.from_charm_and_providers(
+        harness.charm,
+        client_with_mock_external,
+        harness.charm._ingress_provider,
+        harness.charm._gateway_route_provider,
+    )
+    tls_information = TLSInformation.from_charm(
+        harness.charm, charm_config, harness.charm.certificates, harness.charm._gateway_route_provider
+    )
     gateway_resource = gateway_resource_manager._gen_resource(
-        GatewayResourceDefinition(gateway_resource_information, config, tls_information)
+        GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)
     )
 
     assert gateway_resource.spec["gatewayClassName"] == GATEWAY_CLASS_CONFIG
diff --git a/gateway-api-integrator/tests/unit/test_http_route.py b/gateway-api-integrator/tests/unit/test_http_route.py
index ffbb496b..a66614d3 100644
--- a/gateway-api-integrator/tests/unit/test_http_route.py
+++ b/gateway-api-integrator/tests/unit/test_http_route.py
@@ -21,23 +21,9 @@
 from state.http_route import (
     HTTPRouteResourceInformation,
     IngressIntegrationDataValidationError,
-    IngressIntegrationMissingError,
 )
 
 
-def test_http_route_resource_information_integration_missing(harness: Harness):
-    """
-    arrange: Given a charm missing ingress integration.
-    act: Initialize HTTPRouteResourceInformation state component.
-    assert: IngressIntegrationMissingError is raised.
-    """
-    harness.begin()
-    with pytest.raises(IngressIntegrationMissingError):
-        HTTPRouteResourceInformation.from_charm(
-            harness.charm, harness.charm._ingress_provider, harness.charm._gateway_route_provider
-        )
-
-
 def test_http_route_resource_information_validation_error(harness: Harness):
     """
     arrange: Given a charm with ingress integration with invalid data.
@@ -51,12 +37,10 @@ def test_http_route_resource_information_validation_error(harness: Harness):
 
     harness.begin()
     with pytest.raises(IngressIntegrationDataValidationError):
-        HTTPRouteResourceInformation.from_charm(
-            harness.charm, harness.charm._ingress_provider, harness.charm._gateway_route_provider
-        )
+        HTTPRouteResourceInformation._from_ingress(harness.charm._ingress_provider)
 
 
-def test_httproute_gen_resource(
+def test_http_route_gen_resource(
     harness: Harness,
     gateway_relation: dict[str, dict[str, str]],
     config: dict[str, str],
@@ -77,8 +61,8 @@ def test_httproute_gen_resource(
 
     harness.begin()
     charm = harness.charm
-    http_route_resource_information = HTTPRouteResourceInformation.from_charm(
-        charm, charm._ingress_provider, harness.charm._gateway_route_provider
+    http_route_resource_information = HTTPRouteResourceInformation._from_ingress(
+        charm._ingress_provider
     )
     gateway_resource_information = GatewayResourceInformation.from_charm(charm)
     http_route_resource_manager = HTTPRouteResourceManager(
diff --git a/gateway-api-integrator/tests/unit/test_secret.py b/gateway-api-integrator/tests/unit/test_secret.py
index cae52a6c..3e413477 100644
--- a/gateway-api-integrator/tests/unit/test_secret.py
+++ b/gateway-api-integrator/tests/unit/test_secret.py
@@ -9,11 +9,12 @@
 
 from ops.testing import Harness
 
-from resource_manager.secret import (
+from src.resource_manager.secret import (
     SecretResourceDefinition,
     TLSSecretResourceManager,
 )
-from state.tls import TLSInformation
+from src.state.config import CharmConfig
+from src.state.tls import TLSInformation
 
 from .conftest import TEST_EXTERNAL_HOSTNAME_CONFIG
 
@@ -38,7 +39,18 @@ def test_secret_gen_resource(
         labels=harness.charm._labels,
         client=client_with_mock_external,
     )
-    tls_information = TLSInformation.from_charm(harness.charm, harness.charm.certificates)
+    charm_config = CharmConfig.from_charm_and_providers(
+        harness.charm,
+        client_with_mock_external,
+        harness.charm._ingress_provider,
+        harness.charm._gateway_route_provider,
+    )
+    tls_information = TLSInformation.from_charm(
+        harness.charm,
+        charm_config,
+        harness.charm.certificates,
+        harness.charm._gateway_route_provider,
+    )
     secret_resource = secret_resource_manager._gen_resource(
         SecretResourceDefinition.from_tls_information(tls_information, config["external-hostname"])
     )

From b2798a12e471605b652f0571ebd2a4a2c0b2588e Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 14:55:14 +0100
Subject: [PATCH 16/32] remove default for gateway-class and external-hostname

---
 gateway-api-integrator/charmcraft.yaml | 2 --
 1 file changed, 2 deletions(-)

diff --git a/gateway-api-integrator/charmcraft.yaml b/gateway-api-integrator/charmcraft.yaml
index 3cfddf36..dffa5ca0 100644
--- a/gateway-api-integrator/charmcraft.yaml
+++ b/gateway-api-integrator/charmcraft.yaml
@@ -52,11 +52,9 @@ provides:
 config:
   options:
     external-hostname:
-      default: ""
       description: The hostname of the gateway.
       type: string
     gateway-class:
-      default: ""
       description: The gateway class.
       type: string
     enforce-https:

From ec0579943b7242fff26c1af5835abc6218f5a77c Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 16:48:24 +0100
Subject: [PATCH 17/32] fix http route

---
 gateway-api-integrator/src/charm.py           | 11 +++---
 .../src/state/http_route.py                   | 25 ++++----------
 gateway-api-integrator/src/state/tls.py       | 18 ++++++++--
 .../v0/gateway_route.py                       |  2 +-
 gateway-route-configurator/src/charm.py       | 34 +++++++------------
 5 files changed, 42 insertions(+), 48 deletions(-)

diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index 09d2c190..4b6239f1 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -58,14 +58,13 @@
 )
 from state.gateway import GatewayResourceInformation
 from state.http_route import (
-    GatewayRouteHostnameMissingError,
     GatewayRouteRelationDataValidationError,
     GatewayRouteRelationNotReadyError,
     HTTPRouteResourceInformation,
     IngressIntegrationDataValidationError,
     IngressIntegrationMissingError,
 )
-from state.tls import TLSInformation
+from state.tls import HostnameMissingError, TLSInformation
 from state.validation import validate_config_and_integration
 
 logger = logging.getLogger(__name__)
@@ -178,7 +177,7 @@ def _on_get_certificate_action(self, event: ActionEvent) -> None:
             event: Juju event
         """
         hostname = event.params["hostname"]
-        TLSInformation.validate(self)
+        TLSInformation.validate(self, bool(self.model.config.get("enforce-https", False)))
         for request in self._get_certificate_requests():
             if request.common_name == hostname:
                 provider_certificate, private_key = self.certificates.get_assigned_certificate(
@@ -404,7 +403,7 @@ def get_hostname(self) -> str | None:
             IngressIntegrationMissingError,
             IngressIntegrationDataValidationError,
             IngressGatewayRouteConflictError,
-            GatewayRouteHostnameMissingError,
+            HostnameMissingError,
             GatewayRouteRelationDataValidationError,
             GatewayRouteRelationNotReadyError,
             GatewayClassUnavailableError,
@@ -433,12 +432,12 @@ def _define_ingress_resources_and_publish_url(  # pylint: disable=too-many-local
         http_route_resource_information = None
         if config.proxy_mode == ProxyMode.INGRESS:
             http_route_resource_information = HTTPRouteResourceInformation._from_ingress(
-                self._ingress_provider
+                self._ingress_provider, tls_information.hostname
             )
 
         if config.proxy_mode == ProxyMode.GATEWAY_ROUTE:
             http_route_resource_information = HTTPRouteResourceInformation._from_gateway_route(
-                self._gateway_route_provider, tls_information
+                self._gateway_route_provider, tls_information.hostname
             )
 
         if http_route_resource_information is None:
diff --git a/gateway-api-integrator/src/state/http_route.py b/gateway-api-integrator/src/state/http_route.py
index 49fd70a4..ccd0540d 100644
--- a/gateway-api-integrator/src/state/http_route.py
+++ b/gateway-api-integrator/src/state/http_route.py
@@ -32,13 +32,6 @@ class GatewayRouteRelationDataValidationError(CharmStateValidationBaseError):
     """Exception raised when gateway route relation data validation fails."""
 
 
-class GatewayRouteHostnameMissingError(CharmStateValidationBaseError):
-    """Exception raised when hostname not configured in gateway-route mode.
-
-    Hostname is configured either via the gateway-route relation or by setting external-hostname.
-    """
-
-
 @dataclasses.dataclass(frozen=True)
 class HTTPRouteResourceInformation:
     """A component of charm state containing resource definition for kubernetes secret.
@@ -61,19 +54,20 @@ class HTTPRouteResourceInformation:
     service_port_name: str
     filters: list[dict]
     paths: list[str]
-    hostname: str
+    hostname: str | None
 
     @classmethod
     def _from_ingress(
         cls,
         ingress_provider: IngressPerAppProvider,
+        hostname: str | None,
     ) -> "HTTPRouteResourceInformation":
         """Populate fields from ingress integration.
 
         Args:
             charm (ops.CharmBase): The gateway-api-integrator charm.
             ingress_provider (IngressPerAppProvider): The ingress provider class.
-            ingress_integration (ops.Relation): The ingress integration.
+            hostname: The hostname to be used in the HTTPRoute resource.
         """
         try:
             integration_data = ingress_provider.get_data(ingress_provider.relations[0])
@@ -102,7 +96,7 @@ def _from_ingress(
                     ]
                 ),
                 paths=[f"/{integration_data.app.model}-{application_name}"],
-                hostname="",
+                hostname=hostname,
             )
         except DataValidationError as exc:
             raise IngressIntegrationDataValidationError(
@@ -113,23 +107,18 @@ def _from_ingress(
     def _from_gateway_route(
         cls,
         gateway_route_provider: GatewayRouteProvider,
-        tls_information: TLSInformation,
+        hostname: str | None,
     ) -> "HTTPRouteResourceInformation":
         """Populate fields from ingress integration.
 
         Args:
             gateway_route_provider: The gateway route provider library.
-            tls_information: TLS-related information.
+            hostname: The hostname to be used in the HTTPRoute resource.
 
         Raises:
             GatewayRouteRelationDataValidationError: When data validation failed.
             GatewayRouteHostnameMissingError: When hostname is not configured.
         """
-        if tls_information.hostname is None:
-            raise GatewayRouteHostnameMissingError(
-                "No hostname configured. Configure hostname either via"
-                " the gateway-route relation or by setting the external-hostname charm config."
-            )
         relation_data = gateway_route_provider.get_data()
         if relation_data is None:
             raise GatewayRouteRelationNotReadyError("gateway-route relation data not ready.")
@@ -144,7 +133,7 @@ def _from_gateway_route(
                 service_port_name=f"tcp-{service_port}",
                 filters=[],
                 paths=relation_data.application_data.paths,
-                hostname=tls_information.hostname,
+                hostname=hostname,
             )
         except DataValidationError as exc:
             raise GatewayRouteRelationDataValidationError(
diff --git a/gateway-api-integrator/src/state/tls.py b/gateway-api-integrator/src/state/tls.py
index 3bbda0d0..033f54a6 100644
--- a/gateway-api-integrator/src/state/tls.py
+++ b/gateway-api-integrator/src/state/tls.py
@@ -20,6 +20,13 @@ class TlsIntegrationMissingError(CharmStateValidationBaseError):
     """Exception raised when certificates relation is missing."""
 
 
+class HostnameMissingError(CharmStateValidationBaseError):
+    """Exception raised when hostname not configured in enforce_https mode.
+
+    Hostname is configured either via the gateway-route relation or by setting external-hostname.
+    """
+
+
 @dataclasses.dataclass(frozen=True)
 class TLSInformation:
     """A component of charm state containing information about TLS.
@@ -67,7 +74,7 @@ def from_charm(
             hostname = gateway_route_requirer_data.application_data.hostname
 
         if hostname is not None:
-            cls.validate(charm)
+            cls.validate(charm, config.enforce_https)
             for cert in certificates.get_provider_certificates():
                 common_name = cert.certificate.common_name
                 chain = cert.chain
@@ -84,15 +91,22 @@ def from_charm(
         )
 
     @classmethod
-    def validate(cls, charm: ops.CharmBase) -> None:
+    def validate(cls, charm: ops.CharmBase, enforce_https: bool) -> None:
         """Validate the precondition to initialize this state component.
 
         Args:
             charm: The gateway-api-integrator charm.
+            enforce_https: Whether to enforce HTTPS.
 
         Raises:
+            HostnameMissingError: When hostname is not configured.
             TlsIntegrationMissingError: When integration is not ready.
         """
+        if enforce_https:
+            raise HostnameMissingError(
+                "No hostname configured. Configure hostname either via"
+                " the gateway-route relation or by setting the external-hostname charm config."
+            )
         tls_requirer_integration = charm.model.get_relation(TLS_CERTIFICATES_INTEGRATION)
         if (
             tls_requirer_integration is None
diff --git a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index 41951e93..7489d126 100644
--- a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -514,7 +514,7 @@ def provide_gateway_route_requirements(
         name: str,
         model: str,
         port: int,
-        hostname: str,
+        hostname: str | None = None,
         paths: Optional[list[str]] = None,
     ) -> None:
         """Update gateway-route requirements data in the relation.
diff --git a/gateway-route-configurator/src/charm.py b/gateway-route-configurator/src/charm.py
index dd422ede..ca2261f4 100644
--- a/gateway-route-configurator/src/charm.py
+++ b/gateway-route-configurator/src/charm.py
@@ -6,17 +6,14 @@
 """Gateway Route Configurator Charm."""
 
 import logging
-import re
 import typing
 
 import ops
-from charms.gateway_api_integrator.v0.gateway_route import GatewayRouteRequirer
+from charms.gateway_api_integrator.v0.gateway_route import GatewayRouteRequirer, domain
 from charms.traefik_k8s.v2.ingress import DataValidationError, IngressPerAppProvider
 
 logger = logging.getLogger(__name__)
 
-HOSTNAME_REGEX = re.compile(r"^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$")
-
 
 class GatewayRouteConfiguratorCharm(ops.CharmBase):
     """Charm the service."""
@@ -40,22 +37,6 @@ def __init__(self, *args: typing.Any):
 
     def _on_update(self, _: typing.Any) -> None:
         """Handle updates to config or relations."""
-        self.unit.status = ops.MaintenanceStatus("Configuring gateway route")
-
-        # Check config values
-        hostname = str(self.model.config.get("hostname"))
-        paths_str = str(self.model.config.get("paths", "/"))
-
-        if not hostname:
-            self.unit.status = ops.BlockedStatus("Missing 'hostname' config")
-            return
-
-        if not HOSTNAME_REGEX.match(hostname):
-            self.unit.status = ops.BlockedStatus(f"Invalid hostname: {hostname}")
-            return
-
-        paths = [p.strip() for p in paths_str.split(",")]
-
         # Check both relations exist
         ingress_relation = self.model.get_relation("ingress")
         if not ingress_relation:
@@ -72,7 +53,17 @@ def _on_update(self, _: typing.Any) -> None:
             port = data.app.port
 
         except DataValidationError:
-            self.unit.status = ops.BlockedStatus("Invalid ingress data")
+            self.unit.status = ops.BlockedStatus("Invalid requirer data")
+            return
+
+        # Check config values
+        hostname: str | None = typing.cast(str | None, self.model.config.get("hostname"))
+        paths_str = typing.cast(str, self.model.config.get("paths", "/"))
+        paths = [p.strip() for p in paths_str.split(",")]
+
+        self.unit.status = ops.MaintenanceStatus("Configuring gateway route")
+        if hostname and not bool(domain(hostname)):
+            self.unit.status = ops.BlockedStatus(f"Invalid hostname: {hostname}")
             return
 
         self.gateway_route.provide_gateway_route_requirements(
@@ -82,6 +73,7 @@ def _on_update(self, _: typing.Any) -> None:
             paths=paths,
             hostname=hostname,
         )
+
         # Publish the ingress URL to the requirer charm
         if endpoints := self.gateway_route.get_routed_endpoints():
             self.ingress.publish_url(

From 682bb67a14075049ff5421761d5519a82f9445bd Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 16:48:40 +0100
Subject: [PATCH 18/32] remove unused imports

---
 gateway-api-integrator/src/state/http_route.py | 2 --
 1 file changed, 2 deletions(-)

diff --git a/gateway-api-integrator/src/state/http_route.py b/gateway-api-integrator/src/state/http_route.py
index ccd0540d..9d900f78 100644
--- a/gateway-api-integrator/src/state/http_route.py
+++ b/gateway-api-integrator/src/state/http_route.py
@@ -8,8 +8,6 @@
 from charms.gateway_api_integrator.v0.gateway_route import GatewayRouteProvider
 from charms.traefik_k8s.v2.ingress import DataValidationError, IngressPerAppProvider
 
-from state.tls import TLSInformation
-
 from .exception import CharmStateValidationBaseError
 
 INGRESS_RELATION = "gateway"

From e22ca9c711e2e83fb1eb10f543f6eb7e246d8ba1 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 17:02:37 +0100
Subject: [PATCH 19/32] render hostname in httproute resource

---
 .../src/resource_manager/http_route.py               | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/gateway-api-integrator/src/resource_manager/http_route.py b/gateway-api-integrator/src/resource_manager/http_route.py
index 4ade5a48..784e7365 100644
--- a/gateway-api-integrator/src/resource_manager/http_route.py
+++ b/gateway-api-integrator/src/resource_manager/http_route.py
@@ -68,6 +68,7 @@ class HTTPRouteResourceDefinition(ResourceDefinition):
     redirect_https: bool
     paths: list[str]
     filters: list[dict]
+    hostname: str | None
 
     def __init__(
         self,
@@ -128,6 +129,15 @@ def http_route_resource_name(self) -> str:
         """
         return f"{self.gateway_name}-{self.http_route_type}"
 
+    @property
+    def http_route_hostnames(self) -> list[str] | None:
+        """Get the hostnames for the HTTPRoute resource.
+
+        Returns:
+            The list of hostnames or None if hostname is not set.
+        """
+        return None if self.hostname is None else [self.hostname]
+
     def http_route_resource_spec(self, namespace: str) -> dict[str, typing.Any]:
         """Generate a Gateway resource from a gateway resource definition.
 
@@ -156,6 +166,7 @@ def http_route_resource_spec(self, namespace: str) -> dict[str, typing.Any]:
                         ]
                     }
                 ],
+                "hostnames": self.http_route_hostnames,
             }
 
         return {
@@ -178,6 +189,7 @@ def http_route_resource_spec(self, namespace: str) -> dict[str, typing.Any]:
                     ],
                 }
             ],
+            "hostnames": self.http_route_hostnames,
         }
 
 

From 8d882d6d0114d9e4a76b6bf878a2b7eccd05bddf Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 17:06:31 +0100
Subject: [PATCH 20/32] fix lint

---
 gateway-api-integrator/src/resource_manager/__init__.py | 2 +-
 gateway-api-integrator/tests/unit/test_gateway.py       | 5 ++++-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/gateway-api-integrator/src/resource_manager/__init__.py b/gateway-api-integrator/src/resource_manager/__init__.py
index 18cd3eca..ce9959ad 100644
--- a/gateway-api-integrator/src/resource_manager/__init__.py
+++ b/gateway-api-integrator/src/resource_manager/__init__.py
@@ -3,4 +3,4 @@
 # Copyright 2025 Canonical Ltd.
 # See LICENSE file for licensing details.
 
-"""Resource management package for gateway-api-integrator operator."""
\ No newline at end of file
+"""Resource management package for gateway-api-integrator operator."""
diff --git a/gateway-api-integrator/tests/unit/test_gateway.py b/gateway-api-integrator/tests/unit/test_gateway.py
index 0f143c2c..92bb7c36 100644
--- a/gateway-api-integrator/tests/unit/test_gateway.py
+++ b/gateway-api-integrator/tests/unit/test_gateway.py
@@ -116,7 +116,10 @@ def test_gateway_gen_resource(
         harness.charm._gateway_route_provider,
     )
     tls_information = TLSInformation.from_charm(
-        harness.charm, charm_config, harness.charm.certificates, harness.charm._gateway_route_provider
+        harness.charm,
+        charm_config,
+        harness.charm.certificates,
+        harness.charm._gateway_route_provider,
     )
     gateway_resource = gateway_resource_manager._gen_resource(
         GatewayResourceDefinition(gateway_resource_information, charm_config, tls_information)

From 67f52620b36ce2c9b0ba4f335e2d4b3840e55350 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Fri, 20 Feb 2026 17:08:01 +0100
Subject: [PATCH 21/32] fix lint

---
 gateway-api-integrator/tests/unit/test_gateway.py    | 2 ++
 gateway-api-integrator/tests/unit/test_http_route.py | 4 ++--
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/gateway-api-integrator/tests/unit/test_gateway.py b/gateway-api-integrator/tests/unit/test_gateway.py
index 92bb7c36..140584a9 100644
--- a/gateway-api-integrator/tests/unit/test_gateway.py
+++ b/gateway-api-integrator/tests/unit/test_gateway.py
@@ -159,6 +159,8 @@ def test_get_current_gateway(mock_lightkube_client: MagicMock):
         client=mock_lightkube_client,
     )
     gateway = gateway_resource_manager.current_gateway_resource()
+    assert gateway is not None, "Gateway resource should not be None"
+    assert gateway.metadata is not None, "Gateway metadata should not be None"
     assert gateway.metadata.name == "gateway"
 
 
diff --git a/gateway-api-integrator/tests/unit/test_http_route.py b/gateway-api-integrator/tests/unit/test_http_route.py
index a66614d3..fadf910f 100644
--- a/gateway-api-integrator/tests/unit/test_http_route.py
+++ b/gateway-api-integrator/tests/unit/test_http_route.py
@@ -37,7 +37,7 @@ def test_http_route_resource_information_validation_error(harness: Harness):
 
     harness.begin()
     with pytest.raises(IngressIntegrationDataValidationError):
-        HTTPRouteResourceInformation._from_ingress(harness.charm._ingress_provider)
+        HTTPRouteResourceInformation._from_ingress(harness.charm._ingress_provider, None)
 
 
 def test_http_route_gen_resource(
@@ -62,7 +62,7 @@ def test_http_route_gen_resource(
     harness.begin()
     charm = harness.charm
     http_route_resource_information = HTTPRouteResourceInformation._from_ingress(
-        charm._ingress_provider
+        charm._ingress_provider, None
     )
     gateway_resource_information = GatewayResourceInformation.from_charm(charm)
     http_route_resource_manager = HTTPRouteResourceManager(

From bcb25fb61d26de7a17a50dff754101cc3fdf8b5e Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Mon, 23 Feb 2026 21:48:35 +0100
Subject: [PATCH 22/32] fix minor issues

---
 gateway-api-integrator/src/resource_manager/gateway.py   | 1 +
 .../src/resource_manager/http_route.py                   | 6 +++---
 gateway-api-integrator/src/state/tls.py                  | 9 ++-------
 3 files changed, 6 insertions(+), 10 deletions(-)

diff --git a/gateway-api-integrator/src/resource_manager/gateway.py b/gateway-api-integrator/src/resource_manager/gateway.py
index 9c8bc164..ce8de03e 100644
--- a/gateway-api-integrator/src/resource_manager/gateway.py
+++ b/gateway-api-integrator/src/resource_manager/gateway.py
@@ -9,6 +9,7 @@
 
 from lightkube import Client
 from lightkube.core.client import LabelSelector
+from lightkube.core.exceptions import ApiError
 from lightkube.generic_resource import GenericNamespacedResource, create_namespaced_resource
 from lightkube.models.meta_v1 import ObjectMeta
 from lightkube.types import PatchType
diff --git a/gateway-api-integrator/src/resource_manager/http_route.py b/gateway-api-integrator/src/resource_manager/http_route.py
index 784e7365..0bab5929 100644
--- a/gateway-api-integrator/src/resource_manager/http_route.py
+++ b/gateway-api-integrator/src/resource_manager/http_route.py
@@ -130,13 +130,13 @@ def http_route_resource_name(self) -> str:
         return f"{self.gateway_name}-{self.http_route_type}"
 
     @property
-    def http_route_hostnames(self) -> list[str] | None:
+    def http_route_hostnames(self) -> list[str]:
         """Get the hostnames for the HTTPRoute resource.
 
         Returns:
-            The list of hostnames or None if hostname is not set.
+            The list of hostnames or an empty list if hostname is not set.
         """
-        return None if self.hostname is None else [self.hostname]
+        return [] if self.hostname is None else [self.hostname]
 
     def http_route_resource_spec(self, namespace: str) -> dict[str, typing.Any]:
         """Generate a Gateway resource from a gateway resource definition.
diff --git a/gateway-api-integrator/src/state/tls.py b/gateway-api-integrator/src/state/tls.py
index 033f54a6..d98a2a99 100644
--- a/gateway-api-integrator/src/state/tls.py
+++ b/gateway-api-integrator/src/state/tls.py
@@ -74,7 +74,7 @@ def from_charm(
             hostname = gateway_route_requirer_data.application_data.hostname
 
         if hostname is not None:
-            cls.validate(charm, config.enforce_https)
+            cls.validate(charm)
             for cert in certificates.get_provider_certificates():
                 common_name = cert.certificate.common_name
                 chain = cert.chain
@@ -91,7 +91,7 @@ def from_charm(
         )
 
     @classmethod
-    def validate(cls, charm: ops.CharmBase, enforce_https: bool) -> None:
+    def validate(cls, charm: ops.CharmBase) -> None:
         """Validate the precondition to initialize this state component.
 
         Args:
@@ -102,11 +102,6 @@ def validate(cls, charm: ops.CharmBase, enforce_https: bool) -> None:
             HostnameMissingError: When hostname is not configured.
             TlsIntegrationMissingError: When integration is not ready.
         """
-        if enforce_https:
-            raise HostnameMissingError(
-                "No hostname configured. Configure hostname either via"
-                " the gateway-route relation or by setting the external-hostname charm config."
-            )
         tls_requirer_integration = charm.model.get_relation(TLS_CERTIFICATES_INTEGRATION)
         if (
             tls_requirer_integration is None

From 9ecbb80fb6764deacbe1936101785aafee8ab9b9 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Tue, 24 Feb 2026 00:30:49 +0100
Subject: [PATCH 23/32] fix unit tests

---
 gateway-api-integrator/src/charm.py                    | 2 +-
 gateway-api-integrator/src/resource_manager/gateway.py | 1 -
 gateway-api-integrator/tests/unit/test_config.py       | 1 -
 3 files changed, 1 insertion(+), 3 deletions(-)

diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index 4b6239f1..038473c9 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -177,7 +177,7 @@ def _on_get_certificate_action(self, event: ActionEvent) -> None:
             event: Juju event
         """
         hostname = event.params["hostname"]
-        TLSInformation.validate(self, bool(self.model.config.get("enforce-https", False)))
+        TLSInformation.validate(self)
         for request in self._get_certificate_requests():
             if request.common_name == hostname:
                 provider_certificate, private_key = self.certificates.get_assigned_certificate(
diff --git a/gateway-api-integrator/src/resource_manager/gateway.py b/gateway-api-integrator/src/resource_manager/gateway.py
index ce8de03e..9c8bc164 100644
--- a/gateway-api-integrator/src/resource_manager/gateway.py
+++ b/gateway-api-integrator/src/resource_manager/gateway.py
@@ -9,7 +9,6 @@
 
 from lightkube import Client
 from lightkube.core.client import LabelSelector
-from lightkube.core.exceptions import ApiError
 from lightkube.generic_resource import GenericNamespacedResource, create_namespaced_resource
 from lightkube.models.meta_v1 import ObjectMeta
 from lightkube.types import PatchType
diff --git a/gateway-api-integrator/tests/unit/test_config.py b/gateway-api-integrator/tests/unit/test_config.py
index 1536c2a8..487b15d6 100644
--- a/gateway-api-integrator/tests/unit/test_config.py
+++ b/gateway-api-integrator/tests/unit/test_config.py
@@ -19,7 +19,6 @@
 @pytest.mark.parametrize(
     "available_gateway_classes",
     [
-        pytest.param(GATEWAY_CLASS_CONFIG, id="available."),
         pytest.param("not-available", id="not available."),
     ],
 )

From 346b7d988df6a805a00d275a50ef507edfdfc4a7 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Tue, 24 Feb 2026 13:51:39 +0100
Subject: [PATCH 24/32] update hostname validation in lib, remove unused code

---
 .../v0/gateway_route.py                       |  5 ++--
 gateway-api-integrator/src/charm.py           | 24 ------------------
 .../tests/unit/test_charm.py                  | 25 -------------------
 .../v0/gateway_route.py                       | 20 +++++++--------
 4 files changed, 11 insertions(+), 63 deletions(-)

diff --git a/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index 106108be..85b23f9d 100644
--- a/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -92,7 +92,7 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 # Increment this PATCH version before using `charmcraft publish-lib` or reset
 # to 0 if you are raising the major API version
-LIBPATCH = 2
+LIBPATCH = 3
 
 logger = logging.getLogger(__name__)
 GATEWAY_ROUTE_RELATION_NAME = "gateway-route"
@@ -221,8 +221,7 @@ def valid_fqdn(value: str) -> str:
     Args:
         value: The value to validate.
     """
-    fqdn = value[2:] if value.startswith("*.") else value
-    if not bool(domain(fqdn)):
+    if not bool(domain(value)):
         raise ValueError(f"Invalid domain: {value}")
     return value
 
diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index 038473c9..849a4529 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -576,30 +576,6 @@ def _set_status_gateway_address(
         else:
             self.unit.status = WaitingStatus("Gateway address unavailable")
 
-    def _certificates_revocation_needed(self, client: Client, config: CharmConfig) -> bool:
-        """Check if a new certificate is needed.
-
-        Args:
-            client: Lightkube client
-            config: Charm config.
-
-        Returns:
-            True if the current certificate needs to be revoked.
-        """
-        gateway_resource_manager = GatewayResourceManager(
-            labels=self._labels,
-            client=client,
-        )
-        gateway = gateway_resource_manager.current_gateway_resource()
-        if not gateway:
-            return False
-
-        gateway_listeners = gateway.spec["listeners"]  # pyright: ignore[reportOptionalSubscript]
-        listener_hostnames = [listener["hostname"] for listener in gateway_listeners]
-        return not (
-            len(set(listener_hostnames)) == 1 and config.external_hostname == listener_hostnames[0]
-        )
-
 
 if __name__ == "__main__":  # pragma: no cover
     main(GatewayAPICharm)
diff --git a/gateway-api-integrator/tests/unit/test_charm.py b/gateway-api-integrator/tests/unit/test_charm.py
index 24dcfbb9..c8108222 100644
--- a/gateway-api-integrator/tests/unit/test_charm.py
+++ b/gateway-api-integrator/tests/unit/test_charm.py
@@ -174,28 +174,3 @@ def test_create_http_route_insufficient_permission(
     harness.update_config(config)
 
     assert harness.charm.unit.status.name == ops.BlockedStatus.name
-
-
-def test_certificate_revocation_needed_no_listeners(
-    harness: Harness,
-    mock_lightkube_client,
-):
-    """
-    arrange: Given a charm with mocked lightkube client.
-    act: Calls the _certificates_revocation_needed method with a
-    current gateway resource having no listeners.
-    assert: True is returned.
-    """
-    mock_lightkube_client.list = MagicMock(
-        return_value=[
-            GenericNamespacedResource(metadata=ObjectMeta(name="gateway"), spec={"listeners": []})
-        ]
-    )
-    harness.begin()
-
-    # We disable protected-access check here because we need to test that method
-    # pylint: disable=protected-access
-    certificate_revocation_needed = harness.charm._certificates_revocation_needed(
-        mock_lightkube_client, MagicMock()
-    )
-    assert certificate_revocation_needed is True
diff --git a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index 7489d126..85b23f9d 100644
--- a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -92,7 +92,7 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 # Increment this PATCH version before using `charmcraft publish-lib` or reset
 # to 0 if you are raising the major API version
-LIBPATCH = 2
+LIBPATCH = 3
 
 logger = logging.getLogger(__name__)
 GATEWAY_ROUTE_RELATION_NAME = "gateway-route"
@@ -221,8 +221,7 @@ def valid_fqdn(value: str) -> str:
     Args:
         value: The value to validate.
     """
-    fqdn = value[2:] if value.startswith("*.") else value
-    if not bool(domain(fqdn)):
+    if not bool(domain(value)):
         raise ValueError(f"Invalid domain: {value}")
     return value
 
@@ -354,7 +353,7 @@ def _on_endpoint_removed(self, _: EventBase) -> None:
         """Handle relation broken/departed events."""
         self.on.data_removed.emit()
 
-    def get_data(self, relation: Relation) -> Optional[GatewayRouteRequirerData]:
+    def get_data(self, relation: Relation | None = None) -> GatewayRouteRequirerData | None:
         """Fetch requirer data.
 
         Args:
@@ -366,12 +365,11 @@ def get_data(self, relation: Relation) -> Optional[GatewayRouteRequirerData]:
         Returns:
             GatewayRouteRequirerData: Validated data from the gateway-route requirer.
         """
-        requirer_data: Optional[GatewayRouteRequirerData] = None
-        if relation:
+        if requirer_relation := relation or self.relation:
             try:
-                application_data = self._get_requirer_application_data(relation)
-                requirer_data = GatewayRouteRequirerData(
-                    relation_id=relation.id,
+                application_data = self._get_requirer_application_data(requirer_relation)
+                return GatewayRouteRequirerData(
+                    relation_id=requirer_relation.id,
                     application_data=application_data,
                 )
             except DataValidationError as exc:
@@ -384,7 +382,7 @@ def get_data(self, relation: Relation) -> Optional[GatewayRouteRequirerData]:
                     raise GatewayRouteInvalidRelationDataError(
                         f"gateway-route data validation failed for relation: {relation}"
                     ) from exc
-        return requirer_data
+        return None
 
     def _get_requirer_application_data(self, relation: Relation) -> RequirerApplicationData:
         """Fetch and validate the requirer's application databag.
@@ -514,7 +512,7 @@ def provide_gateway_route_requirements(
         name: str,
         model: str,
         port: int,
-        hostname: str | None = None,
+        hostname: str,
         paths: Optional[list[str]] = None,
     ) -> None:
         """Update gateway-route requirements data in the relation.

From e071cc650b9e0fee71b3c2e549eaf8137a4eb5c0 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Tue, 24 Feb 2026 14:48:04 +0100
Subject: [PATCH 25/32] add docs for default mode

---
 gateway-api-integrator/src/state/config.py | 1 +
 1 file changed, 1 insertion(+)

diff --git a/gateway-api-integrator/src/state/config.py b/gateway-api-integrator/src/state/config.py
index 01eca93c..3939132d 100644
--- a/gateway-api-integrator/src/state/config.py
+++ b/gateway-api-integrator/src/state/config.py
@@ -45,6 +45,7 @@ class ProxyMode(StrEnum):
     Attrs:
         GATEWAY_ROUTE: When gateway-route is related.
         INGRESS: when ingress is related.
+        DEFAULT: when gateway-api-integrator is not loadbalancing traffic.
     """
 
     GATEWAY_ROUTE = "gateway-route"

From c676b5043d46c1c9b08c5a32f574fb449d20b487 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Tue, 24 Feb 2026 14:53:34 +0100
Subject: [PATCH 26/32] fix imports

---
 gateway-api-integrator/tests/unit/test_secret.py       | 6 +++---
 gateway-api-integrator/tests/unit_scenario/conftest.py | 2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/gateway-api-integrator/tests/unit/test_secret.py b/gateway-api-integrator/tests/unit/test_secret.py
index 3e413477..bf7711df 100644
--- a/gateway-api-integrator/tests/unit/test_secret.py
+++ b/gateway-api-integrator/tests/unit/test_secret.py
@@ -9,12 +9,12 @@
 
 from ops.testing import Harness
 
-from src.resource_manager.secret import (
+from resource_manager.secret import (
     SecretResourceDefinition,
     TLSSecretResourceManager,
 )
-from src.state.config import CharmConfig
-from src.state.tls import TLSInformation
+from state.config import CharmConfig
+from state.tls import TLSInformation
 
 from .conftest import TEST_EXTERNAL_HOSTNAME_CONFIG
 
diff --git a/gateway-api-integrator/tests/unit_scenario/conftest.py b/gateway-api-integrator/tests/unit_scenario/conftest.py
index 866f5a29..647333fe 100644
--- a/gateway-api-integrator/tests/unit_scenario/conftest.py
+++ b/gateway-api-integrator/tests/unit_scenario/conftest.py
@@ -8,7 +8,7 @@
 import pytest
 from ops import testing
 
-from src.state.config import CharmConfig, ProxyMode
+from state.config import CharmConfig, ProxyMode
 
 TEST_EXTERNAL_HOSTNAME_CONFIG = "www.gateway.internal"
 GATEWAY_CLASS_CONFIG = "cilium"

From 2c47cb3fcce6d28c7d05597c7d799fc054fcd626 Mon Sep 17 00:00:00 2001
From: Phan Trung Thanh <trung.thanh.phan@canonical.com>
Date: Tue, 24 Feb 2026 14:56:06 +0100
Subject: [PATCH 27/32] Apply suggestions from code review

Co-authored-by: Copilot <175728472+Copilot@users.noreply.github.com>
---
 gateway-route-configurator/src/charm.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gateway-route-configurator/src/charm.py b/gateway-route-configurator/src/charm.py
index ca2261f4..c2d3c1db 100644
--- a/gateway-route-configurator/src/charm.py
+++ b/gateway-route-configurator/src/charm.py
@@ -53,7 +53,7 @@ def _on_update(self, _: typing.Any) -> None:
             port = data.app.port
 
         except DataValidationError:
-            self.unit.status = ops.BlockedStatus("Invalid requirer data")
+            self.unit.status = ops.BlockedStatus("Invalid ingress relation data")
             return
 
         # Check config values

From 38374b625b6f38225d7e70173d14f0379d7d85af Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 25 Feb 2026 01:04:09 +0100
Subject: [PATCH 28/32] remove unused exception

---
 gateway-api-integrator/src/charm.py           |  2 -
 .../src/state/http_route.py                   | 37 ++++++++-----------
 2 files changed, 15 insertions(+), 24 deletions(-)

diff --git a/gateway-api-integrator/src/charm.py b/gateway-api-integrator/src/charm.py
index 849a4529..0251ca09 100755
--- a/gateway-api-integrator/src/charm.py
+++ b/gateway-api-integrator/src/charm.py
@@ -58,7 +58,6 @@
 )
 from state.gateway import GatewayResourceInformation
 from state.http_route import (
-    GatewayRouteRelationDataValidationError,
     GatewayRouteRelationNotReadyError,
     HTTPRouteResourceInformation,
     IngressIntegrationDataValidationError,
@@ -404,7 +403,6 @@ def get_hostname(self) -> str | None:
             IngressIntegrationDataValidationError,
             IngressGatewayRouteConflictError,
             HostnameMissingError,
-            GatewayRouteRelationDataValidationError,
             GatewayRouteRelationNotReadyError,
             GatewayClassUnavailableError,
             InvalidCharmConfigError,
diff --git a/gateway-api-integrator/src/state/http_route.py b/gateway-api-integrator/src/state/http_route.py
index 9d900f78..e7cd3f48 100644
--- a/gateway-api-integrator/src/state/http_route.py
+++ b/gateway-api-integrator/src/state/http_route.py
@@ -26,10 +26,6 @@ class GatewayRouteRelationNotReadyError(CharmStateValidationBaseError):
     """Exception raised when gateway route relation data is not ready."""
 
 
-class GatewayRouteRelationDataValidationError(CharmStateValidationBaseError):
-    """Exception raised when gateway route relation data validation fails."""
-
-
 @dataclasses.dataclass(frozen=True)
 class HTTPRouteResourceInformation:
     """A component of charm state containing resource definition for kubernetes secret.
@@ -114,26 +110,23 @@ def _from_gateway_route(
             hostname: The hostname to be used in the HTTPRoute resource.
 
         Raises:
-            GatewayRouteRelationDataValidationError: When data validation failed.
-            GatewayRouteHostnameMissingError: When hostname is not configured.
+            GatewayRouteRelationNotReadyError: When data validation failed.
         """
         relation_data = gateway_route_provider.get_data()
         if relation_data is None:
-            raise GatewayRouteRelationNotReadyError("gateway-route relation data not ready.")
+            raise GatewayRouteRelationNotReadyError(
+                "Validation of gateway-route relation data failed."
+            )
         application_name = relation_data.application_data.name
         service_port = relation_data.application_data.port
-        try:
-            return cls(
-                application_name=application_name,
-                requirer_model_name=relation_data.application_data.model,
-                service_name=f"{gateway_route_provider.charm.app.name}-{application_name}-service",
-                service_port=service_port,
-                service_port_name=f"tcp-{service_port}",
-                filters=[],
-                paths=relation_data.application_data.paths,
-                hostname=hostname,
-            )
-        except DataValidationError as exc:
-            raise GatewayRouteRelationDataValidationError(
-                "Validation of gateway-route relation data failed."
-            ) from exc
+
+        return cls(
+            application_name=application_name,
+            requirer_model_name=relation_data.application_data.model,
+            service_name=f"{gateway_route_provider.charm.app.name}-{application_name}-service",
+            service_port=service_port,
+            service_port_name=f"tcp-{service_port}",
+            filters=[],
+            paths=relation_data.application_data.paths,
+            hostname=hostname,
+        )

From b80237f61a818cbcbb6cb20c3ce3186bbc3c099c Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 25 Feb 2026 01:40:39 +0100
Subject: [PATCH 29/32] don't wait for blocked state

---
 gateway-api-integrator/tests/integration/conftest.py | 7 +------
 1 file changed, 1 insertion(+), 6 deletions(-)

diff --git a/gateway-api-integrator/tests/integration/conftest.py b/gateway-api-integrator/tests/integration/conftest.py
index de6f674b..d32d8caa 100644
--- a/gateway-api-integrator/tests/integration/conftest.py
+++ b/gateway-api-integrator/tests/integration/conftest.py
@@ -118,13 +118,8 @@ async def configured_application_with_tls_fixture(
     )
     await application.model.add_relation(application.name, certificate_provider_application.name)
     await application.model.wait_for_idle(
-        apps=[certificate_provider_application.name],
+        apps=[certificate_provider_application.name, application.name],
         idle_period=30,
         status="active",
     )
-    await application.model.wait_for_idle(
-        apps=[application.name],
-        idle_period=30,
-        status="blocked",
-    )
     return application

From e0eb85e56cceb0075f21274000fe4fdc73bb9dde Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 25 Feb 2026 01:42:07 +0100
Subject: [PATCH 30/32] removed blocked wait since the charm can work in HTTP
 now

---
 .../tests/integration_jubilant/test_charm_jubilant.py           | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gateway-api-integrator/tests/integration_jubilant/test_charm_jubilant.py b/gateway-api-integrator/tests/integration_jubilant/test_charm_jubilant.py
index 89757f95..82d9e2ee 100644
--- a/gateway-api-integrator/tests/integration_jubilant/test_charm_jubilant.py
+++ b/gateway-api-integrator/tests/integration_jubilant/test_charm_jubilant.py
@@ -36,7 +36,7 @@ def test_deploy_charm(juju: jubilant.Juju, gateway_app: str, external_hostname:
             break
 
     juju.remove_relation(gateway_app, "flask-k8s")
-    juju.wait(lambda status: jubilant.all_blocked(status, gateway_app))
+    juju.wait(lambda status: jubilant.all_active(status, gateway_app))
     cmd = (
         "kubectl -n gateway get all,httproute,service "
         f"--selector gateway-api-integrator.charm.juju.is/managed-by={gateway_app} | wc -l"

From 12d015686eb57d86f1f029f6bb5d927b9a08be87 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 25 Feb 2026 11:08:21 +0100
Subject: [PATCH 31/32] fix lint and unit tests

---
 .../gateway_api_integrator/v0/gateway_route.py     |  4 ++--
 .../gateway_api_integrator/v0/gateway_route.py     |  4 ++--
 .../tests/unit/test_configurator_charm.py          | 14 +++++++++++---
 3 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index 85b23f9d..88811ca3 100644
--- a/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-api-integrator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -92,7 +92,7 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 # Increment this PATCH version before using `charmcraft publish-lib` or reset
 # to 0 if you are raising the major API version
-LIBPATCH = 3
+LIBPATCH = 4
 
 logger = logging.getLogger(__name__)
 GATEWAY_ROUTE_RELATION_NAME = "gateway-route"
@@ -512,7 +512,7 @@ def provide_gateway_route_requirements(
         name: str,
         model: str,
         port: int,
-        hostname: str,
+        hostname: str | None,
         paths: Optional[list[str]] = None,
     ) -> None:
         """Update gateway-route requirements data in the relation.
diff --git a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
index 85b23f9d..88811ca3 100644
--- a/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
+++ b/gateway-route-configurator/lib/charms/gateway_api_integrator/v0/gateway_route.py
@@ -92,7 +92,7 @@ def _on_endpoints_removed(self, _: EventBase) -> None:
 
 # Increment this PATCH version before using `charmcraft publish-lib` or reset
 # to 0 if you are raising the major API version
-LIBPATCH = 3
+LIBPATCH = 4
 
 logger = logging.getLogger(__name__)
 GATEWAY_ROUTE_RELATION_NAME = "gateway-route"
@@ -512,7 +512,7 @@ def provide_gateway_route_requirements(
         name: str,
         model: str,
         port: int,
-        hostname: str,
+        hostname: str | None,
         paths: Optional[list[str]] = None,
     ) -> None:
         """Update gateway-route requirements data in the relation.
diff --git a/gateway-route-configurator/tests/unit/test_configurator_charm.py b/gateway-route-configurator/tests/unit/test_configurator_charm.py
index 11186c5e..3dd04cd9 100644
--- a/gateway-route-configurator/tests/unit/test_configurator_charm.py
+++ b/gateway-route-configurator/tests/unit/test_configurator_charm.py
@@ -3,6 +3,9 @@
 
 """Unit tests for the Gateway Route Configurator Charm."""
 
+import json
+import typing
+
 from ops import testing
 
 from charm import GatewayRouteConfiguratorCharm  # pylint: disable=no-name-in-module
@@ -41,14 +44,19 @@ def test_gateway_route_no_hostname(base_state: dict) -> None:
     assert: The charm goes into blocked state with the expected message.
     """
     ctx = testing.Context(GatewayRouteConfiguratorCharm)
-    base_state["config"]["hostname"] = ""
+    base_state["config"].pop("hostname", None)
     state = testing.State(**base_state)
     state = ctx.run(ctx.on.config_changed(), state)
-    assert state.unit_status == testing.BlockedStatus("Missing 'hostname' config")
+    assert state.unit_status == testing.ActiveStatus("Ready")
     gateway_route_relation = next(
         rel for rel in state.relations if rel.endpoint == "gateway-route"
     )
-    assert gateway_route_relation.local_app_data == {}
+    assert (
+        json.loads(
+            typing.cast(dict, gateway_route_relation.local_app_data).get("hostname", "null")
+        )
+        is None
+    )
 
 
 def test_gateway_route_invalid_hostname(base_state: dict) -> None:

From 72c1b37dda1ae076e5808f47898a6a19ec957333 Mon Sep 17 00:00:00 2001
From: tphan025 <trung.thanh.phan@canonical.com>
Date: Wed, 25 Feb 2026 11:11:31 +0100
Subject: [PATCH 32/32] fix lint

---
 gateway-api-integrator/tests/unit/test_charm.py | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/gateway-api-integrator/tests/unit/test_charm.py b/gateway-api-integrator/tests/unit/test_charm.py
index c8108222..2b4cc90b 100644
--- a/gateway-api-integrator/tests/unit/test_charm.py
+++ b/gateway-api-integrator/tests/unit/test_charm.py
@@ -9,8 +9,7 @@
 import pytest
 from httpx import Response
 from lightkube.core.exceptions import ApiError
-from lightkube.generic_resource import GenericNamespacedResource
-from lightkube.models.meta_v1 import ObjectMeta, Status
+from lightkube.models.meta_v1 import Status
 from ops.testing import Harness
 
 from resource_manager.permission import InsufficientPermissionError
